{% extends "base.html" %}
{% block title %} {{ block.super }} - Dashboard{% endblock %}
{% block meta %}<meta http-equiv="refresh" content="1260">{% endblock %}
{% block content %}
{% load humanize %}
<div class="w3-panel w3-topbar w3-bottombar w3-border-orange w3-border">
  <p>Dashboard Last Updated :  <span id='datetime'></span> ... refreshing every 21 minutes</p>
  <script>
    var dt = new Date();
    document.getElementById("datetime").innerHTML = dt.toLocaleTimeString();
  </script>
  <div class="w3-panel w3-pale-green w3-leftbar w3-rightbar w3-border-green w3-border">
    <h3><a href="{{ graph_links }}/{{ network }}node/{{ node_info.identity_pubkey }}" target="_blank">{{ node_info.alias }}</a> <span class="w3-tag w3-round w3-center">{{ node_info.identity_pubkey }}</span></h3>
    <h4>
      Network Statistics:
      <span class="w3-tag w3-round w3-border w3-pale-{% if not node_info.synced_to_graph %}red{% else %}blue{% endif %} w3-center" title="{% if not node_info.synced_to_graph %}Not{% endif %} Synced">LND</span>
      <span class="w3-tag w3-round w3-border w3-pale-{% if not node_info.synced_to_chain %}red{% else %}blue{% endif %} w3-center" title="{% if not node_info.synced_to_chain %}Not{% endif %} Synced">{% for info in node_info.chains %}{{ info }}{% endfor %}</span>
      <span class="w3-tag w3-round w3-border w3-pale-blue w3-center" title="Latest block">{{ node_info.block_height }} # {{ node_info.block_hash }}</span>
      <br/>
      Channels Statistics:
      <span class="w3-tag w3-round w3-border w3-pale-blue w3-center">Public Capacity: {{ total_capacity|intcomma }}</span>
      <span class="w3-tag w3-round w3-border w3-pale-blue w3-center">Active Channels: {{ node_info.num_active_channels }} / {{ total_channels }} (<a href="/peers" target="_blank">{{node_info.num_peers}} Peers</a>)</span>
      <span class="w3-tag w3-round w3-border w3-pale-blue w3-center">DB Size: {% if db_size > 0 %}{{ db_size }} GB{% else %}---{% endif %}</span>
      <span class="w3-tag w3-round w3-border w3-pale-blue w3-center">Total States Updates: {{ num_updates|intcomma|default:"---" }}</span>
      {% if total_private > 0 %}
      <span class="w3-tag w3-round w3-gray w3-center"> Private
        <span class="w3-tag w3-round w3-border w3-pale-blue w3-center">Capacity: {{ private_capacity|intcomma }}</span>
        <span class="w3-tag w3-round w3-border w3-pale-blue w3-center">Locked Liquidity: {{ private_outbound|intcomma }}</span>
        <span class="w3-tag w3-round w3-border w3-pale-blue w3-center">Active Channels: {{ active_private }} / {{ total_private }}</span>
      </span>  
      {% endif %}
      <br/>
      Public Addresses:
      <br/>
      {% for info in node_info.uris %}<button onclick="navigator.clipboard.writeText('{{ info }}')" class="w3-btn w3-round w3-medium" title="Click to copy">{{ info }}</button>{% endfor %}
    </h4>
  </div>
  <form id="newAddr" action="/newaddress/" method="post">
    {% csrf_token %}
  </form>
  <div class="w3-row w3-container w3-padding-small" >
    <table class="w3-col w3-table-all w3-centered w3-hoverable" style="width:30%">
      <tr>
        <th width=5%>#</h>
        <th>Inbound</th>
        <th>Outbound</th>
        <th>Unsettled</th>
      </tr>
      <tr>
        <td>Active</td>
        <td>{{ inbound|intcomma }}</td>
        <td>{{ outbound|intcomma }}</td>
        <td>{{ unsettled|intcomma }}</td>
      </tr>
      <tr>
        <td>Inactive</td>
        <td>{{ inactive_inbound|intcomma }}</td>
        <td>{{ inactive_outbound|intcomma }}</td>
        <td>{{ inactive_unsettled|intcomma }}</td>
      </tr>
      <tr>
        <td>Total</td>
        <td>{{ sum_inbound|intcomma }}</td>
        <td>{{ sum_outbound|intcomma }}</td>
        <td>{{ total_unsettled|intcomma }}</td>
      </tr>
    </table>
    <table class="w3-col w3-table-all w3-centered w3-hoverable" style="width:70%">
      <tr>
        <th>Period</th>
        <th>Routed</th>
        <th>Fees earned/paid</th>
        <th>Offchain fees</th>
        <th>Cost (%)</th>
        <th>Profit</th>
        <th>Outbound Utilization</th>
      </tr>
      <tr>
        <td>1-Day</td>
        <td>{{ routed_1day|intcomma }} ({{ routed_1day_amt|intcomma }} sats)</td>
        <td>{{ earned_1day|intcomma }} [{{ 1day_routed_ppm|intcomma }}]/{{ total_1day_fees|intcomma }} [{{ 1day_payments_ppm|intcomma }}]</td>
        <td>{{ onchain_costs_1day|intcomma }}</td>
        <td>{{ percent_cost_1day }}%</td>
        <td>{{ profit_per_outbound_1d|intcomma }} [{{ profit_per_outbound_real_1d|intcomma }}]</td>
        <td>{{ routed_1day_percent }}%</td>
      </tr>
      <tr>
        <td>7-Day</td>
        <td>{{ routed_7day|intcomma }} ({{ routed_7day_amt|intcomma }} sats)</td>
        <td>{{ earned_7day|intcomma }} [{{ 7day_routed_ppm|intcomma }}]/{{ total_7day_fees|intcomma }} [{{ 7day_payments_ppm|intcomma }}]</td>
        <td>{{ onchain_costs_7day|intcomma }}</td>
        <td>{{ percent_cost_7day }}%</td>
        <td>{{ profit_per_outbound_7d|intcomma }} [{{ profit_per_outbound_real_7d|intcomma }}]</td>
        <td>{{ routed_7day_percent }}%</td>
      </tr>
    </table>
    <h4>
      <span class="w3-tag w3-padding-small w3-round w3-white w3-border w3-center"><a href="/balances" target="_blank">Balance</a>
        <span class="w3-tag w3-round w3-white w3-border w3-center">Total: {{ total_balance|intcomma }}</span>
        <span class="w3-tag w3-round w3-white w3-border w3-center">Onchain: {{ balances.total_balance|intcomma }}</span>
        <span class="w3-tag w3-round w3-white w3-border w3-center">Unconfirmed: {{ balances.unconfirmed_balance|intcomma }}</span>
        <span class="w3-tag w3-round w3-gray w3-center">Limbo: {{ limbo_balance|intcomma }} </span>
        <span class="w3-tag w3-round w3-pale-red w3-center"> <a href="/pending_htlcs" target="_blank">Pending HTLCs</a>: {{ pending_htlc_count }}</span>
      </span>
      <a href="#" onclick="document.getElementById('newAddr').submit()" value="Get New Onchain Address">Get New Onchain Address</a>  
    </h4>
  </div>
  <div class="w3-container w3-padding-small">
    <h4><a href="/income" target="_blank">P&L</a> | <a href="/closures" target="_blank">Closures</a> | <a href="/opens" target="_blank">New Peers</a> | <a href="/actions" target="_blank">AR Actions</a> | <a href="/fees" target="_blank">Fee Rates</a> | <a href="/autopilot" target="_blank">Autopilot</a> | <a href="/autofees" target="_blank">Autofees</a> | <a href="/channels" target="_blank">Channel Performance</a> | <a href="/keysends" target="_blank">Keysends</a> | <a href="/rebalancing" target="_blank">Rebalancing</a> | <a href="/towers" target="_blank">Towers</a> | <a href="/batch" target="_blank">Batching</a> | <a href="/advanced" target="_blank">Advanced Settings</a></h4>
  </div>
</div>
{% if active_channels %}
<div class="w3-container w3-padding-small">
  <h2>Update Channel Policy</h2>
  <form action="/updatechanpolicy/" method="post">
    {% csrf_token %}
    <div class="w3-container w3-padding-small" style="overflow-x: scroll">
      <table class="w3-table-all w3-centered w3-hoverable">
        <tr>
          <th title="Select channels to update policy">
            <input class="w3-check" onclick="document.getElementsByName('target_chans').forEach(i => i.checked = event.target.checked)" type="checkbox" name="target_all">
          </th>
          <th>Channel ID</th>
          <th>Peer Alias</th>
          <th title="y = ax + b">Out Fee</th>
          <th>CLTV</th>
          <th>Routed Out</th>
          <th>Outbound Liquidity</th>
          <th width=15%>Capacity</th>
          <th>Inbound Liquidity</th>
          <th>Routed In</th>
          <th title="y = ax + b">In fee</th>
          <th>Unsettled</th>
          <th title="When AR is ENABLED for the channel, keep pulling IN to the channel until its inbound liquidity falls below the iTarget%." width=4%>iTarget%</th>
          <th>AR</th>
        </tr>
        <form></form>
        {% for channel in active_channels %}
        <tr title="Uptime: {{ channel.last_update|naturaltime|slice:":-4" }}">
          <td><input name="target_chans" id="id_target_chans_{{forloop.counter0}}" class="w3-check" type="checkbox" value="{{channel.chan_id}}"/></td>
          <td title="{{ channel.funding_txid }}:{{ channel.output_index }}"><a href="/channel?={{ channel.chan_id }}" target="_blank">{{ channel.chan_id }}</a></td>
          <td title="{{ channel.remote_pubkey }}"><a href="{{ graph_links }}/{{ network }}node/{{ channel.remote_pubkey }}" target="_blank">{% if channel.alias == '' %}{{ channel.remote_pubkey|slice:":12" }}{% else %}{{ channel.alias }}{% endif %}</a></td>
          <td {% if channel.local_disabled %}style="background-color: #fadbd5"{% endif %} title="Fee rate: {{channel.local_fee_rate|intcomma}} | Base fee: {{channel.local_base_fee|intcomma}}"><small>{{ channel.local_fee_rate|intcomma }}x{% if channel.local_base_fee > 0 %} + {{channel.local_base_fee|intcomma}}{% endif %}</small></td>
          <td>{{channel.local_cltv}}</td>
          <td><div class="w3-row">
            <div title="1 day amount (events)" class="w3-pale-green w3-half"><small>{{ channel.amt_routed_out_1day|intcomma }}M ({{ channel.routed_out_1day }})</small></div>
            <div title="7 days amount (events)" class="w3-lime w3-half"><small>{{ channel.amt_routed_out_7day|intcomma }}M ({{ channel.routed_out_7day }})</small></div></div>
          </td>
          <td><small>{{ channel.local_balance|intcomma }} ({{ channel.outbound_percent }}%)</small></td>
          <td><div class="w3-orange w3-round"><div style="z-index:1;position:absolute;display:flex;justify-content:center;width:14%;">{{ channel.capacity|intcomma }}</div><div class="w3-container w3-round w3-blue" style="height:25px;{% if channel.outbound_percent > 0 %}width:{{ channel.outbound_percent|intcomma }}%{% else %}visibility:hidden{% endif %}"></div></div></td>
          <td><small>{{ channel.remote_balance|intcomma }} ({{ channel.inbound_percent }}%)</small></td>
          <td><div class="w3-row">
            <div title="1 day amount (events)" class="w3-pale-green w3-half"><small>{{ channel.amt_routed_in_1day|intcomma }}M ({{ channel.routed_in_1day }})</small></div>
            <div title="7 days amount (events)" class="w3-lime w3-half"><small>{{ channel.amt_routed_in_7day|intcomma }}M ({{ channel.routed_in_7day }})</small></div></div>
          </td>
          <td {% if channel.local_disabled %}style="background-color: #fadbd5"{% endif %} title="Fee rate: {{channel.remote_fee_rate|intcomma}} | Base fee: {{channel.remote_base_fee|intcomma}}"><small>{{ channel.remote_fee_rate|intcomma }}x{% if channel.remote_base_fee > 0 %} + {{channel.remote_base_fee|intcomma}}{% endif %}</small></td>
          <td><small>{{ channel.unsettled_balance|intcomma }} ({{ channel.htlc_count }})</small></td>
          <td>
            {% if channel.auto_rebalance %}
              <form action="/update_channel/" method="post">
                {% csrf_token %}
                <input style="text-align:center" id="target" type="number" min="1" max="100" name="target" value="{{ channel.ar_in_target }}">
                <input type="hidden" name="chan_id" value="{{ channel.chan_id }}">
                <input type="hidden" name="update_target" value="3">
              </form>
            {% else %}
              ---
            {% endif %}
          </td>
          <td>
            <form action="/update_channel/" method="post">
              {% csrf_token %}
              <input type="submit" value="{% if channel.auto_rebalance %}Dis{% else %}En{% endif %}able"/>
              <input type="hidden" name="chan_id" value="{{ channel.chan_id }}">
              <input type="hidden" name="update_target" value="5">
              <input type="hidden" name="target" value="0">
            </form>
          </td>
        </tr>
        {% endfor %}
      </table>
    </div>
    <div class="w3-col" style="width:25%" >
      <input class="w3-input" placeholder="New Fee Rate" id="new_fee_rate" type="number" min="0" name="new_fee_rate">
    </div>
    <div class="w3-col" style="width:25%" >
      <input class="w3-input" placeholder="New Base Fee" id="new_base_fee" type="number" min="0" name="new_base_fee">
    </div>
    <div class="w3-col" style="width:25%" >
      <input class="w3-input" placeholder="New CLTV" id="new_cltv" type="number" min="18" name="new_cltv">
    </div>
    <div class="w3-col" style="width:25%">
      <input class="w3-button" style="width:100%" type="submit" value="OK">
    </div>
  </form>
</div>
{% endif %}
{% if inactive_channels %}
<div class="w3-container w3-padding-small">
  <h2>Inactive Channels</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Channel ID</th>
      <th>Peer Alias</th>
      <th title="y = ax + b">Out Fee</th>
      <th width=9%>Outbound Liquidity</th>
      <th width=15%>Capacity</th>
      <th width=9%>Inbound Liquidity</th>
      <th title="y = ax + b">In fee</th>
      <th width=6%>Unsettled</th>
      <th width=5%>Local Commit</th>
      <th width=5%>Local Reserve</th>
      <th width=5%>Downtime</th>
      <th width=5%>Opener</th>
      <th width=4%>iTarget%</th>
      <th width=4%>AR</th>
    </tr>
    {% for channel in inactive_channels %}
    <tr>
      <td title="{{ channel.funding_txid }}:{{ channel.output_index }}"><a href="/channel?={{ channel.chan_id }}" target="_blank">{{ channel.chan_id }}</a></td>
      <td title="{{ channel.remote_pubkey }}"><a href="{{ graph_links }}/{{ network }}node/{{ channel.remote_pubkey }}" target="_blank">{% if channel.alias == '' %}{{ channel.remote_pubkey|slice:":12" }}{% else %}{{ channel.alias }}{% endif %}</a></td>
      <td {% if channel.local_disabled %}style="background-color: #fadbd5"{% endif %} title="Fee rate: {{channel.local_fee_rate|intcomma}} | Base fee: {{channel.local_base_fee|intcomma}}"><small>{{ channel.local_fee_rate|intcomma }}x{% if channel.local_base_fee > 0 %} + {{channel.local_base_fee|intcomma}}{% endif %}</small></td>
      <td><small>{{ channel.local_balance|intcomma }}</small></td>
      <td><div class="w3-orange w3-round"><div style="z-index:1;position:absolute;display:flex;justify-content:center;width:14%;">{{ channel.capacity|intcomma }}</div><div class="w3-container w3-round w3-blue" style="height:25px;{% if channel.outbound_percent > 0 %}width:{{ channel.outbound_percent|intcomma }}%{% else %}visibility:hidden{% endif %}"></div></div></td>
      <td><small>{{ channel.remote_balance|intcomma }}</small></td>
      <td {% if channel.remote_disabled %}style="background-color: #fadbd5"{% endif %} title="Fee rate: {{channel.remote_fee_rate|intcomma}} | Base fee: {{channel.remote_base_fee|intcomma}}"><small>{{ channel.remote_fee_rate|intcomma }}x{% if channel.remote_base_fee > 0 %} + {{channel.remote_base_fee|intcomma}}{% endif %}</small></td>
      <td>{{ channel.unsettled_balance|intcomma }}</td>
      <td>{{ channel.local_commit|intcomma }}</td>
      <td>{{ channel.local_chan_reserve|intcomma }}</td>
      <td title="{{ channel.last_update }}">{{ channel.last_update|naturaltime|slice:":-4" }}</td>
      <td>{% if channel.initiator == True %}Local{% else %}Remote{% endif %}</td>
      <td>
        {% if channel.auto_rebalance == True %}
          <form action="/update_channel/" method="post">
            {% csrf_token %}
            <input style="text-align:center" id="target" type="number" min="1" max="100" name="target" value="{{ channel.ar_in_target }}">
            <input type="hidden" name="chan_id" value="{{ channel.chan_id }}">
            <input type="hidden" name="update_target" value="3">
          </form>
        {% else %}
          ---
        {% endif %}
      </td>
      <td>
        <form action="/update_channel/" method="post">
          {% csrf_token %}
          <input type="submit" value="{% if channel.auto_rebalance == True %}Disable{% else %}Enable{% endif %}">
          <input type="hidden" name="chan_id" value="{{ channel.chan_id }}">
          <input type="hidden" name="update_target" value="5">
          <input type="hidden" name="target" value="0">
        </form>
      </td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if private_channels %}
<div class="w3-container w3-padding-small">
  <h2>Private Channels</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Channel ID</th>
      <th>Peer Alias</th>
      <th width=4%>oLife</th>
      <th title="y = ax + b">Out Fee</th>
      <th width=9%>Outbound Liquidity</th>
      <th width=15%>Capacity</th>
      <th width=9%>Inbound Liquidity</th>
      <th width=6%>Unsettled</th>
      <th width=4%>iLife</th>
      <th width=5%>Local Commit</th>
      <th width=5%>Local Reserve</th>
      <th width=5%>Opener</th>
      <th width=5%>Up/Down</th>
    </tr>
    {% for channel in private_channels %}
    <tr>
      <td title="{{ channel.funding_txid }}:{{ channel.output_index }}"><a href="/channel?={{ channel.chan_id }}" target="_blank">{{ channel.chan_id }}</a></td>
      <td title="{{ channel.remote_pubkey }}"><a href="{{ graph_links }}/{{ network }}node/{{ channel.remote_pubkey }}" target="_blank">{% if channel.alias == '' %}{{ channel.remote_pubkey|slice:":12" }}{% else %}{{ channel.alias }}{% endif %}</a></td>
      <td>{{ channel.total_sent|intcomma }}</td>
      <td {% if channel.local_disabled %}style="background-color: #fadbd5"{% endif %} title="Fee rate: {{channel.local_fee_rate|intcomma}} | Base fee: {{channel.local_base_fee|intcomma}}"><small>{{ channel.local_fee_rate|intcomma }}x{% if channel.local_base_fee > 0 %} + {{channel.local_base_fee|intcomma}}{% endif %}</small></td>
      <td><small>{{ channel.local_balance|intcomma }}</small></td>
      <td><div class="w3-orange w3-round"><div style="z-index:1;position:absolute;display:flex;justify-content:center;width:14%;">{{ channel.capacity|intcomma }}</div><div class="w3-container w3-round w3-blue" style="height:25px;{% if channel.outbound_percent > 0 %}width:{{ channel.outbound_percent|intcomma }}%{% else %}visibility:hidden{% endif %}"></div></div></td>
      <td><small>{{ channel.remote_balance|intcomma }}</small></td>
      <td>{{ channel.unsettled_balance|intcomma }}</td>
      <td>{{ channel.total_received|intcomma }}</td>
      <td>{{ channel.local_commit|intcomma }}</td>
      <td>{{ channel.local_chan_reserve|intcomma }}</td>
      <td>{% if channel.initiator == True %}Local{% else %}Remote{% endif %}</td>
      <td {% if channel.is_active == True %}style="background-color: #a6dce2"{% else %}style="background-color: #fadbd5"{% endif %} title="{{ channel.last_update }}">{{ channel.last_update|naturaltime|slice:":-4" }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if pending_open %}
<div class="w3-container w3-padding-small">
  <h2>Pending Open Channels</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Peer Alias</th>
      <th width=20%>Channel Point</th>
      <th>Capacity</th>
      <th>Local Balance</th>
      <th>Remote Balance</th>
      <th>AF</th>
      <th>Fee Rate</th>
      <th>Base Fee</th>
      <th>CLTV</th>
      <th>Amt</th>
      <th>Max Cost%</th>
      <th>oTarget%</th>
      <th>iTarget%</th>
      <th>AR</th>
    </tr>
    {% for channel in pending_open %}
    <tr>
      <td title="{{ channel.remote_node_pub }}"><a href="{{ graph_links }}/{{ network }}node/{{ channel.remote_node_pub }}" target="_blank">{% if channel.alias == '' %}{{ channel.remote_node_pub|slice:":12" }}{% else %}{{ channel.alias }}{% endif %}</a></td>
      <td><a href='{{ network_links }}/{{ network }}tx/{{ channel.funding_txid }}' target="_blank">{{ channel.channel_point }}</a></td>
      <td title="Commit Fee: {{ channel.commit_fee }}">{{ channel.capacity|intcomma }}</td>
      <td>{{ channel.local_balance|intcomma }}</td>
      <td>{{ channel.remote_balance|intcomma }}</td>
      <td {% if channel.auto_fees == False %}style="background-color: #fadbd5"{% else %}style="background-color: #a6dce2"{% endif %}>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input type="submit" value="{% if channel.auto_fees == True %}Disable{% else %}Enable{% endif %}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="8">
          <input type="hidden" name="target" value="0">
        </form>
      </td>
      <td>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="0" max="100000" name="target" value="{{ channel.local_fee_rate }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="1">
        </form>
      </td>
      <td>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="0" max="100000" name="target" value="{{ channel.local_base_fee }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="0">
        </form>
      </td>
      <td>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="18" max="1000" name="target" value="{{ channel.local_cltv }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="9">
        </form>
      </td>
      <td>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="1" max="100000000" name="target" value="{{ channel.ar_amt_target }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="2">
        </form>
      </td>
      <td>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="1" max="100" name="target" value="{{ channel.ar_max_cost }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="6">
        </form>
      </td>
      <td {% if channel.auto_rebalance == False %}style="background-color: #80ced6"{% else %}style="background-color: #f18973"{% endif %}>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="1" max="100" name="target" value="{{ channel.ar_out_target }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="4">
        </form>
      </td>
      <td {% if channel.auto_rebalance == True %}style="background-color: #80ced6"{% else %}style="background-color: #f18973"{% endif %}>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="1" max="100" name="target" value="{{ channel.ar_in_target }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="3">
        </form>
      </td>
      <td>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input type="submit" value="{% if channel.auto_rebalance == True %}Disable{% else %}Enable{% endif %}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="5">
          <input type="hidden" name="target" value="0">
        </form>
      </td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if pending_closed %}
<div class="w3-container w3-padding-small">
  <h2>Pending Close Channels</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Channel ID</th>
      <th>Peer Alias</th>
      <th>Capacity</th>
      <th>Local Balance</th>
      <th>Remote Balance</th>
      <th>Balance In Limbo</th>
      <th>Local Commit Fee</th>
      <th width=20%>Closing TX</th>
    </tr>
    {% for channel in pending_closed %}
    <tr>
      <td title="{{ channel.channel_point }}"><a href="/channel?={{ channel.chan_id }}" target="_blank">{{ channel.chan_id }}</a></td>
      <td title="{{ channel.remote_node_pub }}"><a href="{{ graph_links }}/{{ network }}node/{{ channel.remote_node_pub }}" target="_blank">{% if channel.alias == '' %}{{ channel.remote_node_pub|slice:":12" }}{% else %}{{ channel.alias }}{% endif %}</a></td>
      <td>{{ channel.capacity|intcomma }}</td>
      <td>{{ channel.local_balance|intcomma }}</td>
      <td>{{ channel.remote_balance|intcomma }}</td>
      <td>{{ channel.limbo_balance|intcomma }}</td>
      <td>{{ channel.local_commit_fee_sat|intcomma }}</td>
      <td><a href='{{ network_links }}/{{ network }}tx/{{ channel.closing_txid }}' target="_blank">{{ channel.closing_txid }}</a></td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if pending_force_closed %}
<div class="w3-container w3-padding-small">
  <h2>Pending Force Close Channels</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Channel ID</th>
      <th>Peer Alias</th>
      <th>Capacity</th>
      <th>Local Balance</th>
      <th>Remote Balance</th>
      <th>Balance In Limbo</th>
      <th>Maturity</th>
      <th width=20%>Closing TX</th>
    </tr>
    {% for channel in pending_force_closed %}
    <tr>
      <td title="{{ channel.channel_point }}"><a href="/channel?={{ channel.chan_id }}" target="_blank">{{ channel.chan_id }}</a></td>
      <td title="{{ channel.remote_node_pub }}"><a href="{{ graph_links }}/{{ network }}node/{{ channel.remote_node_pub }}" target="_blank">{% if channel.alias == '' %}{{ channel.remote_node_pub|slice:":12" }}{% else %}{{ channel.alias }}{% endif %}</a></td>
      <td>{{ channel.capacity|intcomma }}</td>
      <td>{{ channel.local_balance|intcomma }}</td>
      <td>{{ channel.remote_balance|intcomma }}</td>
      <td>{{ channel.limbo_balance|intcomma }}</td>
      <td title="Blocks: {{ channel.blocks_til_maturity|intcomma }}">{{ channel.maturity_datetime|naturaltime }}</td>
      <td><a href='{{ network_links }}/{{ network }}tx/{{ channel.closing_txid }}' target="_blank">{{ channel.closing_txid }}</a></td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if waiting_for_close %}
<div class="w3-container w3-padding-small">
  <h2>Channels Waiting To Close</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Channel ID</th>
      <th>Peer Alias</th>
      <th>Capacity</th>
      <th>Local Balance</th>
      <th>Remote Balance</th>
      <th>Balance In Limbo</th>
      <th>Local Commit Fee</th>
      <th width=20%>Closing TX</th>
    </tr>
    {% for channel in waiting_for_close %}
    <tr>
      <td title="{{ channel.channel_point }}"><a href="/channel?={{ channel.chan_id }}" target="_blank">{{ channel.chan_id }}</a></td>
      <td title="{{ channel.remote_node_pub }}"><a href="{{ graph_links }}/{{ network }}node/{{ channel.remote_node_pub }}" target="_blank">{% if channel.alias == '' %}{{ channel.remote_node_pub|slice:":12" }}{% else %}{{ channel.alias }}{% endif %}</a></td>
      <td>{{ channel.capacity|intcomma }}</td>
      <td>{{ channel.local_balance|intcomma }}</td>
      <td>{{ channel.remote_balance|intcomma }}</td>
      <td>{{ channel.limbo_balance|intcomma }}</td>
      <td>{{ channel.local_commit_fee_sat|intcomma }}</td>
      <td><a href='{{ network_links }}/{{ network }}tx/{{ channel.closing_txid }}' target="_blank">{{ channel.closing_txid }}</a></td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if forwards %}
<div class="w3-container w3-padding-small">
  <h2>Last 10  <a href="/forwards" target="_blank">Payments Routed</a></h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Timestamp</th>
      <th>Amount In</th>
      <th>Amount Out</th>
      <th>Channel In Alias</th>
      <th>Channel Out Alias</th>
      <th>Channel In Id</th>
      <th>Channel Out Id</th>
      <th>Fees Earned</th>
      <th>PPM Earned</th>
    </tr>
    {% for forward in forwards %}
    <tr>
      <td title="{{ forward.forward_date }}">{{ forward.forward_date|naturaltime }}</td>
      <td>{{ forward.amt_in|intcomma }}</td>
      <td>{{ forward.amt_out|intcomma }}</td>
      <td>{% if forward.chan_in_alias == '' %}---{% else %}{{ forward.chan_in_alias }}{% endif %}</td>
      <td>{% if forward.chan_out_alias == '' %}---{% else %}{{ forward.chan_out_alias }}{% endif %}</td>
      <td><a href="/channel?={{ forward.chan_id_in }}" target="_blank">{{ forward.chan_id_in }}</a></td>
      <td><a href="/channel?={{ forward.chan_id_out }}" target="_blank">{{ forward.chan_id_out }}</a></td>
      <td>{{ forward.fee|intcomma }}</td>
      <td>{{ forward.ppm|intcomma }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if rebalances %}
<div class="w3-container w3-padding-small">
  <h2>Last 10 <a href="/rebalances" target="_blank">Rebalance Requests</a> (currently scheduling {{ eligible_count }} of {{ enabled_count }} enabled channels for rebalancing via {{ available_count }} outbound channels)</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Requested</th>
      <th>Start</th>
      <th>Stop</th>
      <th>Scheduled Duration</th>
      <th>Actual Duration</th>
      <th>Value</th>
      <th>Fee Limit</th>
      <th>Target PPM</th>
      <th>Fees Paid</th>
      <th>Last Hop Alias</th>
      <th>Status</th>
      <th>Hash</th>
    </tr>
    {% for rebalance in rebalances %}
    <tr>
      <td title="{{ rebalance.requested }}">{{ rebalance.requested|naturaltime }}</td>
      <td title="{{ rebalance.start }}">{{ rebalance.start|naturaltime|default:"---" }}</td>
      <td title="{{ rebalance.stop }}">{{ rebalance.stop|naturaltime|default:"---" }}</td>
      <td>{{ rebalance.duration }} minutes</td>
      <td>{{ rebalance.stop|timeuntil:rebalance.start|default:"---" }}</td>
      <td>{{ rebalance.value|intcomma }}</td>
      <td>{{ rebalance.fee_limit|intcomma }}</td>
      <td>{{ rebalance.ppm|intcomma }}</td>
      <td>{% if rebalance.status == 2 %}{{ rebalance.fees_paid|intcomma }}{% else %}---{% endif %}</td>
      <td>{% if rebalance.target_alias == '' %}---{% else %}{{ rebalance.target_alias }}{% endif %}</td>
      <td title="{{ rebalance.status }}">{% if rebalance.status == 0 %}Pending{% elif rebalance.status == 1 %}In-Flight{% elif rebalance.status == 2 %}<a href="/route?={{ rebalance.payment_hash }}" target="_blank">Successful</a>{% elif rebalance.status == 3 %}Timeout{% elif rebalance.status == 4 %}No Route{% elif rebalance.status == 5 %}Error{% elif rebalance.status == 6 %}Incorrect Payment Details{% elif rebalance.status == 7 %}Insufficient Balance{% elif rebalance.status == 400 %}Rebalancer Request Failed{% elif rebalance.status == 408 %}Rebalancer Request Timeout{% else %}{{ rebalance.status }}{% endif %}</td>
      <td>{% if rebalance.payment_hash == '' %}---{% else %}<a href="/route?={{ rebalance.payment_hash }}" target="_blank">{{ rebalance.payment_hash }}</a>{% endif %}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if payments %}
<div class="w3-container w3-padding-small">
  <h2>Last 5 <a href="/payments" target="_blank">Payments Sent</a></h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Timestamp</th>
      <th width=28%>Hash</th>
      <th width=6%>Value</th>
      <th width=6%>Fee Paid</th>
      <th width=6%>PPM Paid</th>
      <th width=6%>Status</th>
      <th width=12%>Chan Out Alias</th>
      <th width=12%>Chan Out ID</th>
      <th width=4%>Route</th>
      <th width=6%>Keysend</th>
    </tr>
    {% for payment in payments %}
    <tr>
      <td title="{{ payment.creation_date }}">{{ payment.creation_date|naturaltime }}</td>
      <td><a href="/route?={{ payment.payment_hash }}" target="_blank">{{ payment.payment_hash }}</a></td>
      <td>{{ payment.value|add:"0"|intcomma }}</td>
      <td>{{ payment.fee|intcomma }}</td>
      <td>{{ payment.ppm|intcomma }}</td>
      <td>{% if payment.status == 1 %}In-Flight{% elif payment.status == 2 %}Succeeded{% elif payment.status == 3 %}Failed{% else %}{{ payment.status }}{% endif %}</td>
      <td>{% if payment.status == 2 %}{% if payment.chan_out_alias == '' %}---{% else %}{{ payment.chan_out_alias }}{% endif %}{% else %}---{% endif %}</td>
      <td>{% if payment.status == 2 %}{% if payment.chan_out != 'MPP' %}<a href="/channel?={{ payment.chan_out }}" target="_blank">{{ payment.chan_out }}</a>{% else %}{{ payment.chan_out }}{% endif %}{% else %}---{% endif %}</td>
      <td>{% if payment.status == 2 %}<a href="/route?={{ payment.payment_hash }}" target="_blank">Open</a>{% else %}---{% endif %}</td>
      <td title="{{ payment.message }}">{% if payment.keysend_preimage != None %}Yes{% else %}No{% endif %}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if invoices %}
<div class="w3-container w3-padding-small">
  <h2>Last 5 <a href="/invoices" target="_blank">Payments Received</a></h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Created</th>
      <th>Settled</th>
      <th width=25%>Payment Hash</th>
      <th>Value</th>
      <th>Amount Paid</th>
      <th>State</th>
      <th>Channel In Alias</th>
      <th width=10%>Channel In</th>
      <th><a href="/keysends" target="_blank">Keysend</a></th>
    </tr>
    {% for invoice in invoices %}
    <tr>
      <td title="{{ invoice.creation_date }}">{{ invoice.creation_date|naturaltime }}</td>
      <td title="{{ invoice.settle_date }}">{% if invoice.state == 1 %}{{ invoice.settle_date|naturaltime }}{% else %}---{% endif %}</td>
      <td><a href="/route?={{ invoice.r_hash }}" target="_blank">{{ invoice.r_hash }}</td>
      <td>{{ invoice.value|add:"0"|intcomma }}</td>
      <td>{% if invoice.state == 1 %}{{ invoice.amt_paid|intcomma }}{% else %}---{% endif %}</td>
      <td>{% if invoice.state == 0 %}Open{% elif invoice.state == 1 %}Settled{% elif invoice.state == 2 %}Canceled{% else %}{{ invoice.state }}{% endif %}</td>
      <td>{% if invoice.state == 1 %}{% if invoice.chan_in_alias == '' %}---{% else %}{{ invoice.chan_in_alias }}{% endif %}{% else %}---{% endif %}</td>
      <td>{% if invoice.state == 1 and invoice.chan_in != None %}<a href="/channel?={{ invoice.chan_in }}" target="_blank">{{ invoice.chan_in }}</a>{% else %}---{% endif %}</td>
      <td title="{{ invoice.message }}">{% if invoice.keysend_preimage != None %}Yes{% else %}No{% endif %}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if failed_htlcs %}
<div class="w3-container w3-padding-small">
  <h2>Last 10 <a href="/failed_htlcs" target="_blank">Failed HTLCs</a></h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Timestamp</th>
      <th>Chan In ID</th>
      <th>Chan Out ID</th>
      <th>Chan In Alias</th>
      <th>Chan Out Alias</th>
      <th>Forward Amount</th>
      <th>Actual Outbound</th>
      <th>Potential Fee</th>
      <th>HTLC Failure</th>
      <th>Failure Detail</th>
    </tr>
    {% for failed_htlc in failed_htlcs %}
    <tr>
      <td title="{{ failed_htlc.timestamp }}">{{ failed_htlc.timestamp|naturaltime }}</td>
      <td><a href="/channel?={{ failed_htlc.chan_id_in }}" target="_blank">{{ failed_htlc.chan_id_in }}</a></td>
      <td><a href="/channel?={{ failed_htlc.chan_id_out }}" target="_blank">{{ failed_htlc.chan_id_out }}</a></td>
      <td><a href="/failed_htlcs?={{ failed_htlc.chan_id_in }}_I" target="_blank">{% if failed_htlc.chan_in_alias == '' %}---{% else %}{{ failed_htlc.chan_in_alias }}{% endif %}</a></td>
      <td><a href="/failed_htlcs?={{ failed_htlc.chan_id_out }}_O" target="_blank">{% if failed_htlc.chan_out_alias == '' %}---{% else %}{{ failed_htlc.chan_out_alias }}{% endif %}</a></td>
      <td>{{ failed_htlc.amount|intcomma }}</td>
      <td>{{ failed_htlc.chan_out_liq|intcomma }} ({{ failed_htlc.chan_out_pending|intcomma }})</td>
      <td>{{ failed_htlc.missed_fee|intcomma }}</td>
      <td>{% if failed_htlc.wire_failure == 15 %}Temporary Channel Failure{% elif failed_htlc.wire_failure == 18 %}Unknown Next Peer{% elif failed_htlc.wire_failure == 12 %}Fee Insufficient{% else %}{{ failed_htlc.wire_failure }}{% endif %}</td>
      <td>{% if failed_htlc.failure_detail == 1 %}---{% elif failed_htlc.failure_detail == 5 %}HTLC Exceeds Max{% elif failed_htlc.failure_detail == 6 %}Insufficient Balance{% elif failed_htlc.failure_detail == 13 %}Invoice Not Open{% elif failed_htlc.failure_detail == 20 %}Invalid Keysend{% elif failed_htlc.failure_detail == 22 %}Circular Route{% else %}{{ failed_htlc.failure_detail }}{% endif %}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if local_settings %}
<div class="w3-container w3-padding-small">
  <h2><a href="/rebalancing" target="_blank">Auto-Rebalancer</a> Settings</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Key</th>
      <th>Value</th>
    </tr>
    {% for settings in local_settings %}
    <tr>
      <td>{{ settings.key }}</td>
      <td>{{ settings.value|intcomma }}</td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
<div class="w3-container w3-padding-small">
  <h2>Update Auto Rebalancer Settings</h2>
  <div class="w3-container w3-padding-32">
    <form action="/autorebalance/" method="post">
      {% csrf_token %}
      <label title="This enables or disables the auto-scheduling function" for="enabled">Enabled: </label>
      <input id="enabled" type="number" min="0" max="1" name="enabled">
      <label title="The % of the total capacity to target as the rebalance amount" for="target_percent">Target Amount (%): </label>
      <input id="target_percent" type="number" step="0.1" min="0.1" max="100" name="target_percent">
      <label title="The time spent per individual rebalance attempt" for="target_time">Target Time (min): </label>
      <input id="target_time" type="number" min="1" max="60" name="target_time">
      <label title="When a channel is not enabled for targeting; the minimum outbound a channel must have to be a source for refilling another channel" for="outbound_percent">Target Outbound Above (%): </label>
      <input id="outbound_percent" type="number" step="1" min="1" max="100" name="outbound_percent">
      <label title="When a channel is enabled for targeting; the maximum inbound a channel can have before selected for auto rebalance" for="inbound_percent">Target Inbound Above (%): </label>
      <input id="inbound_percent" type="number" step="1" min="1" max="100" name="inbound_percent">
      <label title="The max rate we can ever use to refill a channel with outbound" for="fee_rate">Global Max Fee Rate (ppm): </label>
      <input id="fee_rate" type="number" min="1" max="2500" name="fee_rate">
      <label title="The ppm to target which is the % of the outbound fee rate for the channel being refilled" for="max_cost">Max Cost (%): </label>
      <input id="max_cost" type="number" step="1" min="1" max="100" name="max_cost">
      <label title="The % of the target amount to be randomly varied with every rebalance attempt" for="variance">Variance (%): </label>
      <input id="variance" type="number" min="0" max="100" name="variance">
      <label title="The minutes we should wait after a failed attempt before trying again" for="wait_period">Wait Period (min): </label>
      <input id="wait_period" type="number" min="1" max="100" name="wait_period">
      <label title="This enables or disables the Autopilot function which automatically acts upon suggestions on this page: /actions" for="autopilot">Autopilot: </label>
      <input id="autopilot" type="number" min="0" max="1" name="autopilot">
      <label title="Number of days to consider for autopilot. Default 7." for="autopilotdays">AutopilotDays: </label>
      <input id="autopilotdays" type="number" min="0" max="100" name="autopilotdays">
      <label title="Apply for all existing channels." for="targetallchannels">Target All Channels:? </label>
      <input id="targetallchannels" type="checkbox" name="targetallchannels">
      <input type="submit" value="OK">
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Create Invoice</h2>
  <div class="w3-row-padding">
    <form action="/createinvoice/" method="post">
      {% csrf_token %}
      <div class="w3-col w3-quarter">
        <input id="value" class="w3-input" placeholder="Invoice Amount" min="1" type="number" name="value">
      </div>
      <div class="w3-col w3-quarter">
        <input class="w3-button" type="submit" value="OK">
      </div>
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Connect To A Peer</h2>
  <div class="w3-container w3-row">
    <form action="/connectpeer/"  method="post">
      {% csrf_token %}
      <div class="w3-col w3-half">
        <input class="w3-input" id="peer_id" placeholder="PubKey or Connection String" type="text" name="peer_id">
      </div>
      <div class="w3-col w3-quarter">  
        <input class="w3-button" type="submit" value="OK">
      </div>
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Close A Channel</h2>
  <div class="w3-row-padding">
    <form action="/closechannel/" method="post">
      {% csrf_token %}
      <div class="w3-col w3-quarter">
        <input class="w3-input" placeholder="Channel ID" id="chan_id" type="number" name="chan_id">
      </div>
      <div class="w3-col" style="width:15%">
        <input id="target_fee" class="w3-input" placeholder="Target Fee (sats/byte)" type="number" min="1" max="100" name="target_fee">
      </div>
      <div class="w3-col" style="width:10%">
        <input class="w3-check" id="force" type="checkbox" name="force">
        <label class="w3-validate">Force close </label>
      </div>
      <div class="w3-col" style="width:10%">
        <input class="w3-button" type="submit" value="OK">
      </div>
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Open A Channel</h2>
  <div class="w3-row-padding">
    <form action="/openchannel/" method="post">
      {% csrf_token %}
      <div class="w3-col" style="width:50%">
        <input class="w3-input" id="peer_pubkey" placeholder="Peer Pubkey" type="text" name="peer_pubkey">
      </div>
      <div class="w3-col" style="width:15%">
        <input class="w3-input"  id="local_amt" placeholder="Local Amount" type="number" name="local_amt">
      </div>
      <div class="w3-col" style="width:15%">
        <input class="w3-input"  id="sat_per_byte" placeholder="Target Fee (sats/byte)" type="number" name="sat_per_byte">
      </div>   
      <div class="w3-col" style="width:10%">  
        <input class="w3-button"  type="submit" value="OK">
      </div> 
    </form>
  </div>
</div>
{% endblock %}
