{% extends "base.html" %}
{% block title %} {{ block.super }} - Dashboard{% endblock %}
{% block meta %}<meta http-equiv="refresh" content="1260">{% endblock %}
{% block content %}
{% load humanize %}
<span style="position: absolute;top: 0;right: 0;">Dashboard Last Updated:  <span id='datetime'></span> ... refreshing every 21 minutes</span>
<div class="w3-container w3-padding-small">
  <script language="Javascript">
    var dt = new Date();
    byId("datetime").innerHTML = dt.toLocaleTimeString();
    function qr_gen(addr){
      var qrcode = new QRCode(byId('qrcode'), {text:addr, width:256, height:256})
      byId('qrcode').style.display = 'block'
    }
    function qr_clear(){
      byId('qrcode').replaceChildren()
      byId('qrcode').style.display = 'none'
    }
  </script>
    <h3>
      <span style="font-size: 12px;vertical-align: middle; padding-left: 18px; border:1px solid {{ node_info.color }}; background-color: {{ node_info.color }}" class="w3-circle" title="{{ node_info.color }}"></span>
      <a style="margin-left:6px;" href="{{ graph_links }}/{{ network }}node/{{ node_info.identity_pubkey }}" target="_blank">{{ node_info.alias }}</a> | {{ node_info.identity_pubkey }}
    </h3>
  <h6>
    <span class="w3-tag w3-round w3-{% if node_info.synced_to_graph %}green{% else %}red{% endif %}" title="{{ node_info.version }}">LND</span>
    <span style="padding:1.5px 8px;" class="w3-round w3-border w3-border-{% if node_info.synced_to_chain %}green{% else %}red{% endif %}" title="Chain {% if not node_info.synced_to_chain %}Not {% endif %}Synced">{% for info in node_info.chains %}{{ info }}{% endfor %} | {{ node_info.block_height }} #{{ node_info.block_hash }}</span>
  </h6>
  <h6>
    <span style="padding:1.5px 8px;" class="w3-round w3-border w3-border-grey">Public Capacity: <span id="public_capacity">0</span></span>
    <span style="padding:1.5px 8px;" class="w3-round w3-border w3-border-grey">Active Channels: <span id="public_channels_count">{{node_info.num_active_channels}}</span> / <span id="total_channels">{{node_info.num_active_channels|add:node_info.num_inactive_channels}}</span></span>
    <span style="padding:1.5px 8px;" class="w3-round w3-border w3-border-grey"><a href="/peers" target="_blank">Peers</a>: {{ node_info.num_peers }}</span>
    <span style="padding:1.5px 8px;" class="w3-round w3-border w3-border-grey">DB Size: {% if db_size > 0 %}{{ db_size }} GB{% else %}---{% endif %}</span>
    <span style="padding:1.5px 8px;" class="w3-round w3-border w3-border-grey">Total States Updates: <span id="updates">---</span></span>
    <span style="padding:1.5px 8px;margin-left:4px" class="w3-round w3-border w3-border-grey"><a href="#sign">Sign a message</a></span>
  </h6>
  <h6 id="private_stats"></h6>
  Addresses: 
  {% for addr in node_info.uris %}
  <div class="w3-container" style="height:40px">
    <text readonly style="word-wrap: break-word;vertical-align:top;">{{ addr }}</text>
    <a href="#." data-value="{{addr}}" onclick="toggle(this)" onmouseleave="qr_clear()" onmouseenter="qr_gen('{{ addr }}');">
      <svg style="height:30px;width:30px;transform:matrix(1, 0, 0, 1, 4, 3)" version="1.1" >
        <path style="" fill-rule="evenodd" d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 010 1.5h-1.5a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-1.5a.75.75 0 011.5 0v1.5A1.75 1.75 0 019.25 16h-7.5A1.75 1.75 0 010 14.25v-7.5z"></path>
        <path style="" fill-rule="evenodd" d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0114.25 11h-7.5A1.75 1.75 0 015 9.25v-7.5zm1.75-.25a.25.25 0 00-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 00.25-.25v-7.5a.25.25 0 00-.25-.25h-7.5z"></path>
      </svg>
      <svg style="height:30px;width:30px;visibility:collapse;transform:matrix(1, 0, 0, 1, -30, 3);" version="1.1" >
        <path style="fill:#3fb950;stroke:#3fb950;" fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"></path>
      </svg>
    </a>
    <div style="display:none;position:absolute;top:30px;right:30px;padding:30px;z-index:11;background:white" id="qrcode"></div>
  </div>
  {% endfor %}
</div>
<div class="w3-row w3-container w3-padding-small" >
  <table class="w3-col w3-small w3-table-all w3-centered w3-hoverable" style="min-width:300px;width:25%">
    <tr>
      <th title="Total Inbound/Total Outbound">Ratio: <span id="liq_ratio">0</span></h>
      <th>Inbound</th>
      <th>Outbound</th>
      <th>Unsettled</th>
    </tr>
    <tr>
      <th>Active</th>
      <td id="active_inbound">0</td>
      <td id="active_outbound">0</td>
      <td id="active_unsettled">0</td>
    </tr>
    <tr>
      <th>Inactive</th>
      <td id="inactive_inbound">0</td>
      <td id="inactive_outbound">0</td>
      <td id="inactive_unsettled">0</td>
    </tr>
    <tr>
      <th>Total</th>
      <td id="total_inbound">0</td>
      <td id="total_outbound">0</td>
      <td id="total_unsettled">0</td>
    </tr>
  </table>
  <table class="w3-col w3-small w3-table-all w3-centered w3-hoverable" style="min-width:1000px;width:75%">
    <thead>
      <tr>
        <th class="w3-border-bottom w3-border-right"><a href="/balances" target="_blank">Balance</a>: <span id="total_balance">{{total_balance}}</span></th>
        <th class="w3-border-bottom w3-border-right">Onchain: {{ balances.total_balance|intcomma }}</th>
        <th colspan="2" class="w3-border-bottom w3-border-right">Confirmed: {{ balances.confirmed_balance|intcomma }}</th>
        <th class="w3-border-bottom w3-border-right">Unconfirmed: {{ balances.unconfirmed_balance|intcomma }}</th>
        <th class="w3-border-bottom w3-border-right">Limbo: {{ limbo_balance|intcomma }} </th>
        <th class="w3-border-bottom w3-border-right"><a href="/pending_htlcs" target="_blank">Pending HTLCs</a>: <span id="pending_htlcs">0</span>{{ pending_htlc_count }}</th>
        <th class="w3-border-bottom">
          <form method="post" action="/newaddress/">
            {% csrf_token %}
            <a href="#" onclick="event.target.parentElement.submit()">New Onchain Address</a>
          </form>
        </th>
      </tr>
    </thead>
    <tr>
      <th>Period</th>
      <th>Routed</th>
      <th>Fees Earned</th>
      <th>Fees Paid</th>
      <th>Onchain fees</th>
      <th>Cost</th>
      <th title="Profit made per outbound [profit per outbound including onchain fees]">Profit/Outbound</th>
      <th>Outbound Utilization</th>
    </tr>
    <tr>
      <td>1-Day</td>
      <td id="routed_1day">0</td>
      <td id="earned_1day">0</td>
      <td id="fees_1day">0</td>
      <td id="onchain_costs_1day">0</td>
      <td id="percent_cost_1day">0</td>
      <td id="profit_per_outbound_1d">0</td>
      <td id="routed_1day_percent">0</td>
    </tr>
    <tr>
      <td>7-Day</td>
      <td id="routed_7day">0</td>
      <td id="earned_7day">0</td>
      <td id="fees_7day">0</td>
      <td id="onchain_costs_7day">0</td>
      <td id="percent_cost_7day">0</td>
      <td id="profit_per_outbound_7d">0</td>
      <td id="routed_7day_percent">0</td>
    </tr>
  </table>
</div>
<br/>
<div class="w3-bar w3-border-top" style="background-color: transparent">
  <a class="w3-bar-item w3-hover-blue" href="/income" target="_blank">P&L</a>
  <a class="w3-bar-item w3-hover-blue" href="/closures" target="_blank">Closures</a> 
  <a class="w3-bar-item w3-hover-blue" href="/opens" target="_blank">New Peers</a>
  <a class="w3-bar-item w3-hover-blue" href="/peerevents" target="_blank">Peer Events</a>
  <a class="w3-bar-item w3-hover-blue" href="/actions" target="_blank">AR Actions</a> 
  <a class="w3-bar-item w3-hover-blue" href="/fees" target="_blank">Fee Rates</a>
  <a class="w3-bar-item w3-hover-blue" href="/autopilot" target="_blank">Autopilot</a>
  <a class="w3-bar-item w3-hover-blue" href="/autofees" target="_blank">Fee Log</a>
  <a class="w3-bar-item w3-hover-blue" href="/channels" target="_blank">Channel Performance</a>
  <a class="w3-bar-item w3-hover-blue" href="/keysends" target="_blank">Keysends</a>
  <a class="w3-bar-item w3-hover-blue" href="/rebalancing" target="_blank">Rebalancing</a>
  <a class="w3-bar-item w3-hover-blue" href="/towers" target="_blank">Towers</a>
  <a class="w3-bar-item w3-hover-blue" href="/batch" target="_blank">Batching</a>
  <a class="w3-bar-item w3-hover-blue" href="/advanced" target="_blank">Advanced Settings</a>
</div>
<div id="active_channels_container" class="w3-container w3-padding-small">
  <div class="w3-container w3-padding-small table" style="overflow:auto;max-height:1000px">
    <table class="w3-table-all w3-centered w3-hoverable">
      <thead>
        <tr>
          <th onclick="sortTable(event.target, 0, 'String', 0, 'a')">Channel ID</th>
          <th onclick="sortTable(event.target, 1, 'String', 0, 'a')">Peer Alias</th>
          <th onclick="sortTable(event.target, 2, 'int')">Outbound Liquidity</th>
          <th onclick="sortTable(event.target, 3, 'int', 0, 'label')">Capacity</th>
          <th onclick="sortTable(event.target, 4, 'int')">Inbound Liquidity</th>
          <th onclick="sortTable(event.target, 5, 'int')">Unsettled</th>
          <th width=3% onclick="sortTable(event.target, 6, 'int')">oRate</th>
          <th width=3% onclick="sortTable(event.target, 7, 'int')">oBase</th>
          <th onclick="sortTable(event.target, 8, 'm')">o1D</th>
          <th onclick="sortTable(event.target, 9, 'm')">i1D</th>
          <th onclick="sortTable(event.target, 10, 'm')">o7D</th>
          <th onclick="sortTable(event.target, 11, 'm')">i7D</th>
          <th width=3% onclick="sortTable(event.target, 12, 'int')">iRate</th>
          <th width=3% onclick="sortTable(event.target, 13, 'int')">iBase</th>
          <th title="When AR is ENABLED for the channel, keep pulling IN to the channel until its inbound liquidity falls below the iTarget%." width=4%>iTarget%</th>
          <th title="When AR is ENABLED it will refill the channel with outbound liquidity." width=4%>AR</th>
        </tr>
      </thead>
      <tbody id="active_channels"></tbody>
    </table>
  </div>
</div>
<div id="inactive_channels_container" class="w3-container w3-padding-small">
  <table class="w3-table-all w3-centered w3-hoverable">
    <thead>
      <tr>
        <th onclick="sortTable(event.target, 0, 'String')">Channel ID</th>
        <th onclick="sortTable(event.target, 1, 'String', 0, 'a')">Peer Alias</th>
        <th onclick="sortTable(event.target, 2, ' (')" width=9%>Outbound Liquidity</th>
        <th onclick="sortTable(event.target, 3, 'int', 0, 'label')">Capacity</th>
        <th onclick="sortTable(event.target, 4, ' (')" width=9%>Inbound Liquidity</th>
        <th onclick="sortTable(event.target, 5, ' (')" width=6%>Unsettled</th>
        <th onclick="sortTable(event.target, 6, 'int')" width=4%>oRate</th>
        <th onclick="sortTable(event.target, 7, 'int')" width=4%>oBase</th>
        <th onclick="sortTable(event.target, 8, 'int')" width=4%>iRate</th>
        <th onclick="sortTable(event.target, 9, 'int')" width=4%>iBase</th>
        <th width=5%>Local Commit</th>
        <th width=5%>Local Reserve</th>
        <th width=5%>Downtime</th>
        <th width=5%>Opener</th>
        <th width=4%>iTarget%</th>
        <th width=4%>AR</th>
      </tr>
    </thead>
    <tbody id="inactive_channels"></tbody>
  </table>
</div>
<div id="private_channels_container" class="w3-container w3-padding-small">
  <table class="w3-table-all w3-centered w3-hoverable">
    <thead>
      <tr>
        <th>Channel ID</th>
        <th>Peer Alias</th>
        <th width=9%>Outbound Liquidity</th>
        <th>Capacity</th>
        <th width=9%>Inbound Liquidity</th>
        <th width=6%>Unsettled</th>
        <th width=4%>oRate</th>
        <th width=4%>oBase</th>
        <th width=4%>oLife</th>
        <th width=4%>iLife</th>
        <th width=5%>Local Commit</th>
        <th width=5%>Local Reserve</th>
        <th width=5%>Opener</th>
        <th width=5%>Status</th>
      </tr>
    </thead>
    <tbody id="private_channels"></tbody>
  </table>
</div>
{% if pending_open %}
<div class="w3-container w3-padding-small">
  <h2>Pending Open Channels</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Peer Alias</th>
      <th width=20%>Channel Point</th>
      <th>Capacity</th>
      <th>Local Balance</th>
      <th>Remote Balance</th>
      <th>AF</th>
      <th>Fee Rate</th>
      <th>Base Fee</th>
      <th>CLTV</th>
      <th>Amt</th>
      <th>Max Cost%</th>
      <th>oTarget%</th>
      <th>iTarget%</th>
      <th>AR</th>
    </tr>
    {% for channel in pending_open %}
    <tr>
      <td title="{{ channel.remote_node_pub }}"><a href="{{ graph_links }}/{{ network }}node/{{ channel.remote_node_pub }}" target="_blank">{% if channel.alias == '' %}{{ channel.remote_node_pub|slice:":12" }}{% else %}{{ channel.alias }}{% endif %}</a></td>
      <td><a href='{{ network_links }}/{{ network }}tx/{{ channel.funding_txid }}' target="_blank">{{ channel.channel_point }}</a></td>
      <td title="Commit Fee: {{ channel.commit_fee }}">{{ channel.capacity|intcomma }}</td>
      <td>{{ channel.local_balance|intcomma }}</td>
      <td>{{ channel.remote_balance|intcomma }}</td>
      <td {% if channel.auto_fees == False %}style="background-color: rgba(46,160,67,0.15);"{% else %}style="background-color: rgba(248,81,73,0.15)"{% endif %}>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input type="submit" value="{% if channel.auto_fees == True %}Disable{% else %}Enable{% endif %}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="8">
          <input type="hidden" name="target" value="0">
        </form>
      </td>
      <td>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="0" max="100000" name="target" value="{{ channel.local_fee_rate }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="1">
        </form>
      </td>
      <td>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="0" max="100000" name="target" value="{{ channel.local_base_fee }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="0">
        </form>
      </td>
      <td>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="18" max="1000" name="target" value="{{ channel.local_cltv }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="9">
        </form>
      </td>
      <td>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="1" max="100000000" name="target" value="{{ channel.ar_amt_target }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="2">
        </form>
      </td>
      <td>
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="1" max="100" name="target" value="{{ channel.ar_max_cost }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="6">
        </form>
      </td>
      <td style="background-color: {% if channel.auto_rebalance == False %}rgba(248,81,73,0.15){% else %}rgba(46,160,67,0.15){% endif %}">
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="1" max="100" name="target" value="{{ channel.ar_out_target }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="4">
        </form>
      </td>
      <td style="background-color: {% if channel.auto_rebalance == True %}rgba(46,160,67,0.15){% else %}rgba(248,81,73,0.15){% endif %}">
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input style="text-align:center" id="target" type="number" min="1" max="100" name="target" value="{{ channel.ar_in_target }}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="3">
        </form>
      </td>
      <td style="background-color: {% if channel.auto_rebalance == True %}rgba(46,160,67,0.15){% else %}rgba(248,81,73,0.15){% endif %}">
        <form action="/update_pending/" method="post">
          {% csrf_token %}
          <input type="submit" value="{% if channel.auto_rebalance == True %}Disable{% else %}Enable{% endif %}">
          <input type="hidden" name="funding_txid" value="{{ channel.funding_txid }}">
          <input type="hidden" name="output_index" value="{{ channel.output_index }}">
          <input type="hidden" name="update_target" value="5">
          <input type="hidden" name="target" value="0">
        </form>
      </td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if pending_closed %}
<div class="w3-container w3-padding-small">
  <h2>Pending Close Channels</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Channel ID</th>
      <th>Peer Alias</th>
      <th>Capacity</th>
      <th>Local Balance</th>
      <th>Remote Balance</th>
      <th>Balance In Limbo</th>
      <th>Local Commit Fee</th>
      <th width=20%>Closing TX</th>
    </tr>
    {% for channel in pending_closed %}
    <tr>
      <td title="{{ channel.channel_point }}"><a href="/channel?={{ channel.chan_id }}" target="_blank">{{ channel.short_chan_id }}</a></td>
      <td title="{{ channel.remote_node_pub }}"><a href="{{ graph_links }}/{{ network }}node/{{ channel.remote_node_pub }}" target="_blank">{% if channel.alias == '' %}{{ channel.remote_node_pub|slice:":12" }}{% else %}{{ channel.alias }}{% endif %}</a></td>
      <td>{{ channel.capacity|intcomma }}</td>
      <td>{{ channel.local_balance|intcomma }}</td>
      <td>{{ channel.remote_balance|intcomma }}</td>
      <td>{{ channel.limbo_balance|intcomma }}</td>
      <td>{{ channel.local_commit_fee_sat|intcomma }}</td>
      <td><a href='{{ network_links }}/{{ network }}tx/{{ channel.closing_txid }}' target="_blank">{{ channel.closing_txid }}</a></td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if pending_force_closed %}
<div class="w3-container w3-padding-small">
  <h2>Pending Force Close Channels</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Channel ID</th>
      <th>Peer Alias</th>
      <th>Capacity</th>
      <th>Local Balance</th>
      <th>Remote Balance</th>
      <th>Balance In Limbo</th>
      <th>Maturity</th>
      <th width=20%>Closing TX</th>
    </tr>
    {% for channel in pending_force_closed %}
    <tr>
      <td title="{{ channel.channel_point }}"><a href="/channel?={{ channel.chan_id }}" target="_blank">{{ channel.short_chan_id }}</a></td>
      <td title="{{ channel.remote_node_pub }}"><a href="{{ graph_links }}/{{ network }}node/{{ channel.remote_node_pub }}" target="_blank">{% if channel.alias == '' %}{{ channel.remote_node_pub|slice:":12" }}{% else %}{{ channel.alias }}{% endif %}</a></td>
      <td>{{ channel.capacity|intcomma }}</td>
      <td>{{ channel.local_balance|intcomma }}</td>
      <td>{{ channel.remote_balance|intcomma }}</td>
      <td>{{ channel.limbo_balance|intcomma }}</td>
      <td title="Blocks: {{ channel.blocks_til_maturity|intcomma }}">{{ channel.maturity_datetime|naturaltime }}</td>
      <td><a href='{{ network_links }}/{{ network }}tx/{{ channel.closing_txid }}' target="_blank">{{ channel.closing_txid }}</a></td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if waiting_for_close %}
<div class="w3-container w3-padding-small">
  <h2>Channels Waiting To Close</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Channel ID</th>
      <th>Peer Alias</th>
      <th>Capacity</th>
      <th>Local Balance</th>
      <th>Remote Balance</th>
      <th>Balance In Limbo</th>
      <th>Local Commit Fee</th>
      <th width=20%>Closing TX</th>
    </tr>
    {% for channel in waiting_for_close %}
    <tr>
      <td title="{{ channel.channel_point }}"><a href="/channel?={{ channel.chan_id }}" target="_blank">{{ channel.short_chan_id }}</a></td>
      <td title="{{ channel.remote_node_pub }}"><a href="{{ graph_links }}/{{ network }}node/{{ channel.remote_node_pub }}" target="_blank">{% if channel.alias == '' %}{{ channel.remote_node_pub|slice:":12" }}{% else %}{{ channel.alias }}{% endif %}</a></td>
      <td>{{ channel.capacity|intcomma }}</td>
      <td>{{ channel.local_balance|intcomma }}</td>
      <td>{{ channel.remote_balance|intcomma }}</td>
      <td>{{ channel.limbo_balance|intcomma }}</td>
      <td>{{ channel.local_commit_fee_sat|intcomma }}</td>
      <td><a href='{{ network_links }}/{{ network }}tx/{{ channel.closing_txid }}' target="_blank">{{ channel.closing_txid }}</a></td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
<div id="routed_container" class="w3-container w3-padding-small">
  <table class="w3-table-all w3-centered w3-hoverable">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Amount In</th>
        <th>Amount Out</th>
        <th>Channel In Alias</th>
        <th>Channel Out Alias</th>
        <th>Channel In Id</th>
        <th>Channel Out Id</th>
        <th>Fees Earned</th>
        <th>PPM Earned</th>
      </tr>
    </thead>
    <tbody id="routed">
    </tbody>
  </table>
</div>
{% include 'rebalances_table.html' with count=10 title='<a href="/rebalances" target="_blank">Rebalance Requests</a>' %}
<div id="payments_container" class="w3-container w3-padding-small">
  <table class="w3-table-all w3-centered w3-hoverable">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Value</th>
        <th>Fee Paid</th>
        <th>PPM Paid</th>
        <th>Status</th>
        <th>Chan Out Alias</th>
        <th>Chan Out ID</th>
        <th>Hash</th>
        <th>Rebalance</th>
        <th>Keysend</th>
      </tr>
    </thead>
    <tbody id="payments"></tbody>
  </table>
</div>
<div id="invoices_container" class="w3-container w3-padding-small">
  <table class="w3-table-all w3-centered w3-hoverable">
    <thead>
      <tr>
        <th>Created</th>
        <th>Settled</th>
        <th>Value</th>
        <th>Amount Paid</th>
        <th>State</th>
        <th>Channel In Alias</th>
        <th>Channel In</th>
        <th>Hash</th>
        <th><a href="/keysends" target="_blank">Keysend</a></th>
      </tr>
    </thead>
    <tbody id="invoices"></tbody>
  </table>
</div>
<div id="failed_htlcs_container" class="w3-container w3-padding-small">
  <table class="w3-table-all w3-centered w3-hoverable">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Chan In ID</th>
        <th>Chan Out ID</th>
        <th>Chan In Alias</th>
        <th>Chan Out Alias</th>
        <th>Forward Amount</th>
        <th>Actual Outbound</th>
        <th>Potential Fee</th>
        <th>HTLC Failure</th>
        <th>Failure Detail</th>
      </tr>
    </thead>
    <tbody id="failed_htlcs"></tbody>
  </table>
</div>
{% include 'local_settings.html' with settings=local_settings title="Auto-Rebalancer" url='rebalancing' %}
<div class="w3-container w3-padding-small">
  <h2>Connect to a Peer</h2>
  <div class="w3-container w3-padding-small">
    <form action="/connectpeer/" method="post">
      {% csrf_token %}
      <input style="min-width:70%" placeholder="PK or PK@host:port" id="peer_id" type="text" name="peer_id">
      <input type="submit" value="OK">
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Open a Channel</h2>
  <div class="w3-container w3-padding-small">
    <form action="/openchannel/" method="post">
      {% csrf_token %}
      <span class="input" style="width:55%">
        <input style="width:100%" placeholder="Public Key" id="peer_pubkey" type="text" name="peer_pubkey">
      </span>
      <span class="input" data-unit="sats">
        <input id="local_amt" placeholder="0" type="number" name="local_amt">
      </span>
      <span class="input" data-unit="sats/vbyte" title="Opening tx fee">
        <input id="sat_per_byte" placeholder="0" type="number" min="1" name="sat_per_byte">
      </span>
      <input type="submit" value="OK">
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Close a Channel</h2>
  <div class="w3-container w3-padding-small">
    <form action="/closechannel/" method="post">
      {% csrf_token %}
      <span class="input">
        <input placeholder="Channel ID" id="chan_id" type="text" name="chan_id">
      </span>
      <div class="input" data-unit="sats/vbyte" title="Closing tx fee">
        <input id="target_fee" placeholder="0" type="number" min="1" name="target_fee">
      </div>
      <label style="top:-4px;position:relative" title="Force Close" for="force">FC</label>
      <input class="w3-check" id="force" style="top:2px" title="Force Close?" type="checkbox" name="force">
      <input type="submit" style="position:relative;top:-4px" value="OK">
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Create Invoice</h2>
  <div class="w3-container w3-padding-small">
    <form action="/createinvoice/" method="post">
      {% csrf_token %}
      <span class="input" data-unit="sats">
        <input placeholder="0" id="value" type="number" name="value">
      </span>
      <input type="submit" value="OK">
    </form>
  </div>
</div>
<div class="w3-container w3-padding-small">
  <h2>Sign a Message</h2>
  <div class="w3-container w3-padding-small">
    <form action="/sign_message/" method="post">
      {% csrf_token %}
      <input placeholder="Message" id="sign" style="min-width:800px" id="value" type="text" name="msg">
      <input type="submit" value="OK">
    </form>
  </div>
</div>
<script>
  const now = new Date(),
    _1day_ago = new Date(new Date().setDate(now.getDate()-1)).getTime(),
    _7days_ago = new Date(new Date().setDate(now.getDate()-7)).toISOString().substring(0,19)

  const base_ch_template = {
    "remote_pubkey": ch => ({innerHTML: `<a href="/channel?=${ch.chan_id}" target="_blank">${ch.short_chan_id}</a>`, title: `${ch.funding_txid}:${ch.output_index}`}),
    "chan_id": ch => ({innerHTML: `<a href="{{graph_links}}/{{network}}node/${ch.remote_pubkey}" target="_blank">${ch.alias == '' ? ch.remote_pubkey.substring(0,20) : ch.alias}</a>`, title: ch.remote_pubkey}),
    "local_balance": ch => ({innerHTML: `${ch.local_balance.intcomma()} <small class="w3-round w3-border-small w3-border-grey">${ch.percent_outbound}%</span>`}),
    "capacity": ch => ({innerHTML: `<label>${ch.capacity.intcomma()}</label>
    <div class="progress w3-round w3-grey">
      <span class="value w3-round w3-blue" style="width:${ch.percent_outbound}%"></span>
    </div>`}),
    "remote_balance": ch => ({innerHTML: `${ch.remote_balance.intcomma()} <small class="w3-round w3-border-small w3-border-grey">${ch.percent_inbound}%</span>`}),
    "unsettled": ch => (ch.unsettled_balance > 0 ? {innerHTML: `${ch.unsettled_balance.intcomma()} <small class="w3-round w3-border-small w3-border-grey">${ch.htlc_count}</span>`} : {innerHTML: `${ch.unsettled_balance.intcomma()}`, style: {color: 'gray'} }),
    "oRate": ch => ({innerHTML: `<span class="input" style="min-width:100px;max-width:120px;width:100%" data-unit="ₚₚₘ"><input style="text-align:left;width:100%" type="number" min="0" size="6" max="100000" value="${ch.local_fee_rate}" onkeydown="event.keyCode != 13? null : (Sync.POST('chanpolicy/', {body: {chan_id:'${ch.chan_id}', fee_rate: this.value}}, r => {flash(this, r.fee_rate);showBannerMsg('Out Fee Rate', r.fee_rate)}));"/></span>`, style: {backgroundColor: ch.local_disabled ? red : null} }),
    "oBase": ch => ({innerHTML: ch.local_base_fee.intcomma(), style: {backgroundColor: ch.local_disabled ? red : null} }),
  }
  const detailed_ch_template = Object.assign({}, base_ch_template, {
    "o1D": ch => ({innerHTML: `${(ch.amt_routed_out_1day/1000000).toFixed(2)}M <small class="w3-round w3-border-small w3-border-grey">${ch.routed_out_1day}</span>`, style: {color: ch.routed_out_1day > 0 ? `` : 'gray'} }),
    "i1D": ch => ({innerHTML: `${(ch.amt_routed_in_1day/1000000).toFixed(2)}M <small class="w3-round w3-border-small w3-border-grey">${ch.routed_in_1day}</span>`, style: {color: ch.routed_in_1day > 0 ? `` : 'gray'} }),
    "o7D": ch => ({innerHTML: `${(ch.amt_routed_out_7day/1000000).toFixed(2)}M <small class="w3-round w3-border-small w3-border-grey">${ch.routed_out_7day}</span>`, style: {color: ch.routed_out_7day > 0 ? `` : 'gray'} }),
    "i7D": ch => ({innerHTML: `${(ch.amt_routed_in_7day/1000000).toFixed(2)}M <small class="w3-round w3-border-small w3-border-grey">${ch.routed_in_7day}</span>`, style: {color: ch.routed_in_7day > 0 ? `` : 'gray'} }),
    "iRate": ch => ({innerHTML: ch.remote_fee_rate.intcomma(), style: {backgroundColor: ch.remote_disabled ? red : null} }),
    "iBase": ch => ({innerHTML: ch.remote_base_fee.intcomma(), style: {backgroundColor: ch.remote_disabled ? red : null} }),
    "ar_in_target": ch => ({innerHTML: !ch.auto_rebalance ? '---' : `<input inputmode="numeric" style="min-width:50px;max-width:75px;text-align:center;width:100%" id="target" type="text" min="1" max="100" name="target" value="${ch.ar_in_target}" onChange="Sync.PUT('channels/${ch.chan_id}', {body: {ar_in_target: this.value}}, r => {flash(this, r.ar_in_target)});">`, style: ch.auto_rebalance ? {backgroundColor: green} : {color: 'gray'} }),
    "auto_rebalance": ch => ({innerHTML: `<input type="submit" data-chan-id="${ch.chan_id}" value="${ch.auto_rebalance ? 'Dis' : 'En'}able" onclick="toggleAR(this)">`, style: {backgroundColor: ch.auto_rebalance ? green : null} }),
  })
  let {iRate, iBase, ar_in_target, auto_rebalance} = detailed_ch_template
  const inactive_ch_template = Object.assign({}, base_ch_template, {iRate, iBase}, {
    "local_commit": ch => ({innerHTML: ch.local_commit.intcomma()}),
    "local_chan_reserve": ch => ({innerHTML: ch.local_chan_reserve.intcomma()}),
    "last_update": ch =>  ({innerHTML: formatDate(ch.last_update).replace(" ago", ""), title: adjustTZ(ch.last_update)}),
    "initiator": ch => ({innerHTML: ch.initiator ? 'Local': 'Remote'}),
  }, {ar_in_target, auto_rebalance})

  let {local_commit, local_chan_reserve, initiator} = inactive_ch_template
  const private_ch_template = Object.assign({}, base_ch_template, {
    "total_sent": ch => ({innerHTML: ch.total_sent.intcomma()}),
    "total_received": ch => ({innerHTML: ch.total_received.intcomma()})
  }, {local_commit, local_chan_reserve, initiator}, {
    "is_active": ch => ({innerHTML: ch.is_active, title: (ch.is_active ? 'Up' : 'Down') + 'time: ' + formatDate(ch.last_update).replace(" ago", ""), style: {backgroundColor: ch.is_active ? green : red} })
  })
  const routed_template = {
    "forward_date": f => ({innerHTML: formatDate(f.forward_date), title: adjustTZ(f.forward_date) }),
    "amt_in": f => ({innerHTML: f.amt_in > 1000 ? f.amt_in.intcomma() : f.amt_in}),
    "amt_out": f => ({innerHTML: f.amt_out > 1000 ? f.amt_out.intcomma() : f.amt_out}),
    "chan_in_alias": f => ({innerHTML: f.chan_in_alias.default(f.chan_id_in)}),
    "chan_out_alias": f => ({innerHTML: f.chan_out_alias.default(f.chan_id_out)}),
    "chan_id_in": f => ({innerHTML: `<a href="/channel?=${f.chan_id_in}" target="_blank">${(BigInt(f.chan_id_in)>>40n)+'x'+(BigInt(f.chan_id_in)>>16n & BigInt('0xFFFFFF'))+'x'+(BigInt(f.chan_id_in) & BigInt('0xFFFF'))}</a>`}),
    "chan_id_out": f => ({innerHTML: `<a href="/channel?=${f.chan_id_out}" target="_blank">${(BigInt(f.chan_id_out)>>40n)+'x'+(BigInt(f.chan_id_out)>>16n & BigInt('0xFFFFFF'))+'x'+(BigInt(f.chan_id_out) & BigInt('0xFFFF'))}</a>`}),
    "fee": f => ({innerHTML: parseFloat(f.fee.toFixed(3)).toLocaleString()}),
    "ppm": f => ({innerHTML: parseInt(f.ppm.toFixed(0)).toLocaleString()}),
  }
  let {fee, ppm} = routed_template
  const payments_template = Object.assign({}, {
    "creation_date": p => ({innerHTML: formatDate(p.creation_date), title: adjustTZ(p.creation_date) }),
    "value": p => ({innerHTML: p.value.intcomma()}),
    "fee": p => ({innerHTML: parseFloat(p.fee.toFixed(3)).toLocaleString()})
    }, {ppm}, {
    "status": p => ({innerHTML: ['Unknown', 'In-Flight', 'Succeeded', 'Failed'][p.status]}),
    "chan_out_alias": p => ({innerHTML: p.chan_out_alias||'---'}),
    "chan_out": p => ({innerHTML: p.status == 2 && p.chan_out !== 'MPP' ? `<a href="/channel?=${p.chan_out}" target="_blank">${(BigInt(p.chan_out)>>40n)+'x'+(BigInt(p.chan_out)>>16n & BigInt('0xFFFFFF'))+'x'+(BigInt(p.chan_out) & BigInt('0xFFFF'))}` : p.chan_out.default('---')}),
    "payment_hash": p => ({innerHTML: `<a href="/route?=${p.payment_hash}" target="_blank">${p.payment_hash.substring(0,7)}</a>`}),
    "rebal_chan": p => ({innerHTML: (p.rebal_chan || '').length > 0 ? 'Yes' : 'No'}),
    "keysend_preimage": p => ({innerHTML: p.keysend_preimage ? 'Yes' : 'No'})
    }
  )
  let {creation_date, value, keysend_preimage} = payments_template
  const invoices_template = Object.assign({}, {creation_date}, {
    "settle_date": i => ({innerHTML: formatDate(i.settle_date), title: adjustTZ(i.settle_date)})
    }, {value}, {
    "amt_paid": i => ({innerHTML: i.amt_paid.intcomma()}),
    "state": i => ({innerHTML: ['Open', 'Settled', 'Cancelled', 'Accepted'][i.state]}),
    "chan_in_alias": i => ({innerHTML: i.chan_in_alias||'---'}),
    "chan_in": i => ({innerHTML: i.chan_in? `<a href="/channel?=${i.chan_in}" target="_blank">${(BigInt(i.chan_in)>>40n)+'x'+(BigInt(i.chan_in)>>16n & BigInt('0xFFFFFF'))+'x'+(BigInt(i.chan_in) & BigInt('0xFFFF'))}</a>` : '---'}),
    "r_hash": i => ({innerHTML: `<a href="/route?=${i.r_hash}" target="_blank">${i.r_hash.substring(0,7)}</a>`}),
    "keysend_preimage": i => ({innerHTML: keysend_preimage(i).innerHTML, title: i.message }),
    }
  )
  const wire_failures = "0|1|2|3|4|5|6|7|8|9|10|Amount Below Minimum|Fee Insufficient|13|14|Temporary Channel Failure|16|17|Unknown Next Peer|19|20|21|Expiry Too Far".split('|')
  const failure_details = "0|---|2|3|4|HTLC Exceeds Max|Insufficient Balance|7|8|9|10|11|12|Invoice Not Open|14|15|16|17|18|19|Invalid Keysend|21|Circular Route".split('|')
  const failedHTLCs_template = {
    "timestamp": htlc => ({innerHTML: formatDate(htlc.timestamp), title: adjustTZ(htlc.timestamp) }),
    "chan_id_in": htlc => ({innerHTML: `<a href="/channel?=${htlc.chan_id_in}" target="_blank">${(BigInt(htlc.chan_id_in)>>40n)+'x'+(BigInt(htlc.chan_id_in)>>16n & BigInt('0xFFFFFF'))+'x'+(BigInt(htlc.chan_id_in) & BigInt('0xFFFF'))}</a>`}),
    "chan_id_out": htlc => ({innerHTML: `<a href="/channel?=${htlc.chan_id_out}" target="_blank">${(BigInt(htlc.chan_id_out)>>40n)+'x'+(BigInt(htlc.chan_id_out)>>16n & BigInt('0xFFFFFF'))+'x'+(BigInt(htlc.chan_id_out) & BigInt('0xFFFF'))}</a>`}),
    "chan_in_alias": htlc => ({innerHTML: `<a href="/failed_htlcs?=${htlc.chan_id_in}_I" target="_blank">${htlc.chan_in_alias || htlc.chan_id_in}</a>`}),
    "chan_out_alias": htlc => ({innerHTML: `<a href="/failed_htlcs?=${htlc.chan_id_out}_O" target="_blank">${htlc.chan_out_alias || htlc.chan_id_out}</a>`}),
    "amount": htlc => ({innerHTML: htlc.amount.intcomma()}),
    "chan_out_liq": htlc => ({innerHTML: `${(htlc.chan_out_liq || 0).intcomma()} <small title="Pending at HTLC time" class="w3-round w3-border-small w3-border-grey">${htlc.chan_out_pending}</small>`}),
    "missed_fee": htlc => ({innerHTML: parseFloat(htlc.missed_fee.toFixed(3)).toLocaleString()}),
    "wire_failure": htlc => ({innerHTML: htlc.wire_failure > wire_failures.length ? htlc.wire_failure : wire_failures[htlc.wire_failure]}),
    "failure_detail": htlc => ({innerHTML: htlc.failure_detail > failure_details.length ? htlc.failure_detail : failure_details[htlc.failure_detail]}),
  }
  function toggleAR(button){
    Sync.PUT(`channels/${button.dataset.chanId}`, {body:{auto_rebalance: button.value == 'Enable' }}, function (ch) { 
      button.parentElement.previousElementSibling.apply(detailed_ch_template.ar_in_target(ch))
      button.parentElement.apply(detailed_ch_template.auto_rebalance(ch))
    })
  }
  function addTitle(id, results, title = null){
    const container = byId(id.toLowerCase().replace(" ", "_") + '_container')
    if (results.length == 0) {
      container.remove()
      return false
    }
    container.insertAdjacentHTML('afterbegin', `<h2>${title || id}</h2>`)
    return true
  }
  function sumRoutedValues(forwards, ch, fields){
    let earned = 0
    for(field of fields) ch[field] = 0
    for(f of forwards){
      if(f.chan_id_in == ch.chan_id){
        ch[fields[0]] += 1
        ch[fields[2]] += f.amt_in_msat/1000
      }
      if(f.chan_id_out == ch.chan_id){
        earned += f.fee
        ch[fields[1]] += 1
        ch[fields[3]] += f.amt_out_msat/1000
      }
    }
    return {rOUTed: {count: ch[fields[1]], amt: ch[fields[3]]}, earned }
  }
  function build_active(channels, forwards7d){
    let sum = {capacity: 0, inbound: 0, outbound: 0, unsettled: 0, earned:{d1:0, d7:0}, rOUTed:{d1:{amt:0, count:0}, d7:{amt:0, count:0} } }
    if(!addTitle("Active Channels", channels)) return sum

    const [activeChannels, template] = [byId("active_channels"), use(detailed_ch_template)]
    forwards1d = forwards7d.filter(f => new Date(f.forward_date).getTime() >= _1day_ago)

    channels.map(ch => { //derived properties
      ch.inbound_can = ch.percent_inbound / ch.ar_in_target
      ch.fee_ratio = ch.local_fee_rate == 0 ? 100 : parseInt(ch.remote_fee_rate*100/ch.local_fee_rate)
      ch.fee_check = parseInt(ch.fee_ratio*100/ch.ar_max_cost)
      
      sum.capacity += ch.capacity
      sum.inbound += ch.remote_balance
      sum.outbound += ch.local_balance
      sum.unsettled += ch.unsettled_balance
      
      var {rOUTed, earned} = sumRoutedValues(forwards1d, ch, ['', 'amt_'].flatMap(p => [p+'routed_in_1day', p+'routed_out_1day']))
      sum.earned.d1 += earned
      sum.rOUTed.d1.amt += rOUTed.amt
      sum.rOUTed.d1.count += rOUTed.count

      var {rOUTed, earned} = sumRoutedValues(forwards7d, ch, ['', 'amt_'].flatMap(p => [p+'routed_in_7day', p+'routed_out_7day']))
      sum.earned.d7 += earned
      sum.rOUTed.d7.amt += rOUTed.amt
      sum.rOUTed.d7.count += rOUTed.count

      return ch
    }).sort((ch1, ch2) => ch1.percent_outbound - ch2.percent_outbound)
      .forEach(ch => activeChannels.append(template.render(ch)))

    byId('public_capacity').innerHTML = sum.capacity.intcomma()
    return update_sum('active_', sum)
  }
  function build_private(channels, forwards7d){
    let act = {outbound: 0, inbound: 0}, ina = {outbound: 0, inbound: 0} 
    let sum = {earned:{d1:0, d7:0}, rOUTed:{d1:{amt:0, count:0}, d7:{amt:0, count:0} } }
    if(!addTitle("Private Channels", channels)) return Object.assign({}, sum, {outbound: act.outbound + ina.outbound, inbound: act.inbound + ina.inbound})

    const forwards1d = forwards7d.filter(f => new Date(f.forward_date).getTime() >= _1day_ago)
    let [capacity, active_count, table, template] = [0,0,byId('private_channels'),use(private_ch_template)]
    channels.forEach(ch => {
      capacity += ch.capacity
      if(ch.is_active) {
        active_count += 1
        act.outbound += ch.local_balance
        act.inbound += ch.remote_balance
      }
      else {
        ina.outbound += ch.local_balance
        ina.inbound += ch.remote_balance
      }

      var {rOUTed, earned} = sumRoutedValues(forwards1d, ch, ['', 'amt_'].flatMap(p => [p+'routed_in_1day', p+'routed_out_1day']))
      sum.earned.d1 += earned
      sum.rOUTed.d1.amt += rOUTed.amt
      sum.rOUTed.d1.count += rOUTed.count

      var {rOUTed, earned} = sumRoutedValues(forwards7d, ch, ['', 'amt_'].flatMap(p => [p+'routed_in_7day', p+'routed_out_7day']))
      sum.earned.d7 += earned
      sum.rOUTed.d7.amt += rOUTed.amt
      sum.rOUTed.d7.count += rOUTed.count
      table.append(template.render(ch))
    })

    byId("total_channels").innerHTML = (byId("total_channels").innerHTML.toInt() - channels.length)
    byId("public_channels_count").innerHTML = (byId("public_channels_count").innerHTML.toInt() - active_count)
    byId("private_stats").insertAdjacentHTML('beforeend', `
      <span style="padding:1.5px 8px;" class="w3-round w3-border w3-border-grey">Private Capacity: ${capacity.intcomma()}</span>
      <span style="padding:1.5px 8px;" class="w3-round w3-border w3-border-grey">Locked Liquidity: ${(act.outbound + ina.outbound).intcomma()}</span>
      <span style="padding:1.5px 8px;" class="w3-round w3-border w3-border-grey">Active Private Channels: ${active_count} / ${channels.length}</span>`)

    return Object.assign({}, sum, {outbound: act.outbound + ina.outbound, inbound: act.inbound + ina.inbound})
  }
  function build_inactive(channels){
    let sum = {capacity: 0, inbound: 0, outbound: 0, unsettled: 0}
    if(!addTitle("Inactive Channels", channels)) return sum

    const table = byId('inactive_channels'), template = use(inactive_ch_template), public_capacity = byId('public_capacity')
    channels.forEach(ch => {
      sum.capacity += ch.capacity
      sum.inbound += ch.remote_balance
      sum.outbound += ch.local_balance
      sum.unsettled += ch.unsettled_balance
      table.append(template.render(ch))
    })

    public_capacity.innerHTML = (public_capacity.innerHTML.toInt() + sum.capacity).intcomma()
    return update_sum('inactive_', sum)
  }
  function update_sum(status, sum){
    for (id of ['inbound', 'outbound', 'unsettled']){
      const [value, total] = [sum[id], byId('total_'+id)]

      byId(status+id).innerHTML = value.intcomma()
      total.innerHTML = (total.innerHTML.toInt() + value).intcomma()
    }
    return sum
  }
  async function update_summary(payments7d, onchain_task, closures_task, active, inactive, private){
    let offChain = {d1: {fee:0, amt:0}, d7: {fee:0, amt:0} }
    for(p of payments7d){
      if(new Date(p.creation_date).getTime() >= _1day_ago){
        offChain.d1.fee += p.fee
        offChain.d1.amt += p.value
      } 
      offChain.d7.fee += p.fee
      offChain.d7.amt += p.value
    }
    let chainCosts = {d1: 0, d7:0}
    for(tx of (await onchain_task).results){
      if(new Date(tx.time_stamp).getTime() >= _1day_ago){
        chainCosts.d1 += tx.fee
      }
      chainCosts.d7 += tx.fee
    }
    for(close of (await closures_task).results){
      if(close.close_height >= ({{node_info.block_height}} - 144)){
        chainCosts.d1 += close.closing_costs
      }
      chainCosts.d7 += close.closing_costs
    }
    function merge(obj, other){
      const result = Object.assign({}, obj)
    
      for(let [key, value] of Object.entries(other)){
        if(value instanceof Object) result[key] = merge(result[key], value) //deep sum
        else result[key] = (result[key] || 0) + value 
      }
      return result
    }
    
    const public = merge(active, inactive), sum = merge(public, private)
    const [total_outbound, total_bal] = [sum.outbound || 1, byId('total_balance')]
    byId('liq_ratio').innerHTML = (public.inbound*100/public.outbound||1).intcomma()+'%'
    total_bal.innerHTML = (total_bal.innerHTML.toInt() + sum.outbound).intcomma()

    for(d of [1,7]){ //build 1 & 7 days table statistics
      const earned = sum.earned[`d${d}`], routed = sum.rOUTed[`d${d}`], chaincosts = chainCosts[`d${d}`], offchain = offChain[`d${d}`], costs = chaincosts + offchain.fee
      byId(`routed_${d}day`).innerHTML = `${routed.amt.intcomma()} <small class="w3-round w3-border-small w3-border-grey">${routed.count.intcomma()}</span>`
      byId(`earned_${d}day`).innerHTML = `${earned.intcomma()} <small class="w3-round w3-border-small w3-border-grey">${(earned*1000000/(routed.amt||1)).intcomma()}ₚₚₘ</small>`
      byId(`fees_${d}day`).innerHTML = `${offchain.fee.intcomma()} <small class="w3-round w3-border-small w3-border-grey">${(offchain.fee*1000000/(offchain.amt||1)).intcomma()}ₚₚₘ</small>`
      byId(`onchain_costs_${d}day`).innerHTML = chaincosts.intcomma()
      byId(`percent_cost_${d}day`).innerHTML = (earned ? costs*100/earned : 0).intcomma()+'%'
      byId(`profit_per_outbound_${d}d`).innerHTML = `<span class="w3-round w3-border-small w3-border-grey">⚡${((earned - offchain.fee)*1000000/total_outbound).intcomma()}ₚₚₘ</span> 
        <span class="w3-round w3-border-small w3-border-grey">⛓️${((earned - costs)*1000000/total_outbound).intcomma()}ₚₚₘ</span>`
      byId(`routed_${d}day_percent`).innerHTML = parseFloat((routed.amt*100/total_outbound).toFixed(1)).toLocaleString()+'%'
    }
  }
  async function build_routed(forwards7d){
    let remaining = 20-forwards7d.length, template = use(routed_template), forwards = forwards7d
    if(remaining > 0)
      forwards = [...forwards, ...(await GET('forwards', {data: {forward_date__lt: _7days_ago, limit: remaining} })).results]

    if(!addTitle('Routed', forwards, `Last 20 <a href="/forwards" target="_blank">Payments Routed</a>`)) return
    const table = byId('routed')
    for(f of forwards.slice(0,20)){
      f.amt_in = f.amt_in_msat/1000
      f.amt_out = f.amt_out_msat/1000
      f.ppm = f.fee*1000000/f.amt_out
      table.append(template.render(f))
    }
  }
  async function build_payments(payments7d){
    let remaining = 10-payments7d.length, template = use(payments_template), payments = payments7d
    if(remaining > 0) payments = [...payments, ...(await GET('payments', {data: {creation_date__lt: _7days_ago, status__lt:3, limit: remaining} })).results]

    if(!addTitle('Payments', payments, `Last 10 <a href="/payments" target="_blank">Payments</a>`)) return
    const table = byId('payments')
    for(p of payments.slice(0,10)){
      p.ppm = p.fee*1000000/p.value
      table.append(template.render(p))
    }
  }
  function build_invoices(invoices){
    if(!addTitle('Invoices', invoices, `Last 10 <a href="/invoices" target="_blank">Invoices</a>`)) return
    const table = byId('invoices'), template = use(invoices_template)
    for(inv of invoices) {
      table.append(template.render(inv))
    }
  }
  function build_failedHTLC(fHTLCs){
    if(!addTitle('failed_htlcs', fHTLCs, `Last 10 <a href="/failed_htlcs" target="_blank">Failed HTLCs</a>`)) return
    const table = byId('failed_htlcs'), template = use(failedHTLCs_template)
    for(htlc of fHTLCs){
      table.append(template.render(htlc))
    } 
  }
  document.addEventListener('DOMContentLoaded', async () =>{
    const invoices_task = GET('invoices', {data: {state__lt: 2, limit: 10} })
    const onchain_task = GET('onchain', {data: {time_stamp__gte: _7days_ago} })
    const forwards7d_task = GET('forwards', {data: {forward_date__gte: _7days_ago} })
    const failedHTLCs_task = GET('failedhtlcs', {data: {wire_failure__lt: 99, limit:10} })
    const payments_task = GET('payments', {data: {creation_date__gte: _7days_ago, status: 2} })
    const closures_task = GET('closures', {data: {close_height__gte: ({{node_info.block_height}} - 1008) } })
    
    let [updates, pending_htlcs, active, inactive, private] = [0,0,[],[],[]]
    for (ch of (await GET('channels', {data: {is_open:true} })).results){ //basic setup
      updates += ch.num_updates
      pending_htlcs += ch.htlc_count
      ch.local_balance += ch.pending_outbound
      ch.remote_balance += ch.pending_inbound
      ch.percent_inbound = parseInt(ch.remote_balance*100/ch.capacity)
      ch.percent_outbound = parseInt(ch.local_balance*100/ch.capacity)

      if(ch.private) private.push(ch)
      else (ch.is_active ? active : inactive).push(ch)
    }

    byId("updates").innerHTML = updates.intcomma()
    byId("pending_htlcs").innerHTML = pending_htlcs.intcomma()

    let [forwards7d, payments7d] = [(await forwards7d_task).results, (await payments_task).results]
    let [activeSum, privateSum, inactiveSum] = [build_active(active, forwards7d), build_private(private, forwards7d), build_inactive(inactive)]
    update_summary(payments7d, onchain_task, closures_task, activeSum, inactiveSum, privateSum)
    build_routed(forwards7d)
    build_payments(payments7d)
    build_invoices((await invoices_task).results)
    build_failedHTLC((await failedHTLCs_task).results)
  })
</script>
{% endblock %}
