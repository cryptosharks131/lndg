{% extends "base.html" %}
{% block title %} {{ block.super }} - Rebalancing{% endblock %}
{% block content %}
{% load humanize %}
{% if channels %}
<div class="w3-container w3-padding-small">
  <h2>Channel <a href="/rebalancing">Rebalancing</a> (currently scheduling {{ eligible_count }} of {{ enabled_count }} enabled channels for rebalancing via {{ available_count }} outbound channels)</h2>
  <div class="w3-container w3-padding-small" style="overflow-x: scroll">
    <table id="rebalancingTable" class="w3-table-all w3-centered w3-hoverable">
      <tr>
        <th title="Select outgoing channels for a manual rebalance request">Out<input onclick="[...document.getElementsByClassName('chan_id')].forEach(el => el.checked = this.checked)" class="w3-check" type="checkbox"/></th>
        <th onclick="sortTable(event.target, 0, 'String')">Channel ID</th>
        <th onclick="sortTable(event.target, 1, 'String', 0, 'a')">Peer Alias</th>
        <th onclick="sortTable(event.target, 2, ' (')">Outbound Liquidity</th>
        <th onclick="sortTable(event.target, 3, 'int', 0, 'label')">Capacity</th>
        <th onclick="sortTable(event.target, 4, ' (')">Inbound Liquidity</th>
        <th><a href="/rebalancing?=2">Rebal Out?</a></th>
        <th><a href="/rebalancing?=1">Enabled?</a></th>
        <th onclick="sortTable(event.target, 7, '%')" title="This ratio must be below the channel's Max Cost %.">Fee Ratio</th>
        <th onclick="sortTable(event.target, 8, 'String')">Rebal In?</th>
        <th title="When AR is ENABLED for the channel, the size of the rebalance attempts that should be tried during attempts to refill the channel.">Target Amt</th>
        <th title="When AR is ENABLED, the maximum percentage amount of the local fee rate that can be used for the max rebalancing cost.">Max Cost %</th>
        <th title="When AR is NOT ENABLED for the channel, keep pushing OUT the channel until its outbound liquidity falls below the oTarget%.">oTarget%</th>
        <th title="When AR is ENABLED for the channel, keep pulling IN to the channel until its inbound liquidity falls below the iTarget%.">iTarget%</th>
        <th>AR</th>
        <th title="The rate of successful rebalances on this channel.">7-Day Rate</th>
        <th onclick="sortTable(event.target, 15, 'String')">Active</th>
      </tr>
      {% for channel in channels %}
      <tr>
        <td><input onchange="this.checked ? document.getElementById('rebal_form').prepend(this.cloneNode({type:'hidden', name:'outgoing_chan_ids', id:'chan_id_{{forloop.counter0}}'})) : document.getElementById('chan_id_{{forloop.counter0}}').remove()" value="{{channel.chan_id}}" class="w3-check chan_id" type="checkbox"/></td>
        <td title="{{ channel.funding_txid }}:{{ channel.output_index }}"><a href="/channel?={{ channel.chan_id }}" target="_blank">{{ channel.short_chan_id }}</a></td>
        <td title="{{ channel.remote_pubkey }}"><a href="{{ graph_links }}/{{ network }}node/{{ channel.remote_pubkey }}" target="_blank">{% if channel.alias == '' %}{{ channel.remote_pubkey|slice:":12" }}{% else %}{{ channel.alias }}{% endif %}</a></td>
        <td>{{ channel.local_balance|intcomma }} ({{ channel.percent_outbound }}%)</td>
        <td>
          <label>{{channel.capacity|intcomma}}</label>
          <div class="progress w3-round w3-grey">
            <span class="value w3-round w3-blue" style="width:{{channel.percent_outbound|default:"0"}}%"></span>
          </div>
        </td>
        <td>{{ channel.remote_balance|intcomma }} ({{ channel.percent_inbound }}%)</td>
        <td {% if channel.percent_outbound >= channel.ar_out_target and channel.auto_rebalance == False %}style="background-color: rgba(46,160,67,0.15);">True{% else %}style="background-color: rgba(248,81,73,0.15)">False{% endif %}</td>
        <td {% if channel.auto_rebalance  == True %}style="background-color: rgba(46,160,67,0.15);">True{% else %}style="background-color: rgba(248,81,73,0.15)">False{% endif %}</td>
        <td {% if channel.fee_check < 100 %}style="background-color: rgba(46,160,67,0.15);">{{ channel.fee_ratio }}%{% else %}style="background-color: rgba(248,81,73,0.15)">{{ channel.fee_ratio }}%{% endif %}</td>
        <td {% if channel.inbound_can >= 1 and channel.fee_check < 100 and channel.auto_rebalance == True %}style="background-color: rgba(46,160,67,0.15);">True ({{ channel.steps }}){% else %}style="background-color: rgba(248,81,73,0.15)">False{% endif %}</td>
        <td>
          <form action="/update_channel/" method="post">
            {% csrf_token %}
            <input style="text-align:center" id="target" type="number" min="0" max="100000000" name="target" value="{{ channel.ar_amt_target }}">
            <input type="hidden" name="chan_id" value="{{ channel.chan_id }}">
            <input type="hidden" name="update_target" value="2">
          </form>
        </td>
        <td>
          <form action="/update_channel/" method="post">
            {% csrf_token %}
            <input style="text-align:center" id="target" type="number" min="0" max="100" name="target" value="{{ channel.ar_max_cost }}">
            <input type="hidden" name="chan_id" value="{{ channel.chan_id }}">
            <input type="hidden" name="update_target" value="6">
          </form>
        </td>
        <td {% if channel.auto_rebalance == False %}style="background-color: rgba(46,160,67,0.15);"{% else %}style="background-color: rgba(248,81,73,0.15)"{% endif %}>
          <form action="/update_channel/" method="post">
            {% csrf_token %}
            <input style="text-align:center" id="target" type="number" min="0" max="100" name="target" value="{{ channel.ar_out_target }}">
            <input type="hidden" name="chan_id" value="{{ channel.chan_id }}">
            <input type="hidden" name="update_target" value="4">
          </form>
        </td>
        <td {% if channel.auto_rebalance == True %}style="background-color: rgba(46,160,67,0.15);"{% else %}style="background-color: rgba(248,81,73,0.15)"{% endif %}>
          <form action="/update_channel/" method="post">
            {% csrf_token %}
            <input style="text-align:center" id="target" type="number" min="0" max="100" name="target" value="{{ channel.ar_in_target }}">
            <input type="hidden" name="chan_id" value="{{ channel.chan_id }}">
            <input type="hidden" name="update_target" value="3">
          </form>
        </td>
        <td {% if channel.auto_rebalance == True %}style="background-color: rgba(46,160,67,0.15);"{% else %}style="background-color: rgba(248,81,73,0.15)"{% endif %}>
          <form action="/update_channel/" method="post">
            {% csrf_token %}
            <input type="submit" value="{% if channel.auto_rebalance == True %}Disable{% else %}Enable{% endif %}">
            <input type="hidden" name="chan_id" value="{{ channel.chan_id }}">
            <input type="hidden" name="update_target" value="5">
            <input type="hidden" name="target" value="0">
          </form>
        </td>
        <td>{% if channel.attempts == 0 %}---{% else %}{{ channel.success_rate }}% ({{ channel.success }}/{{ channel.attempts }}){% endif %}</td>
        <td title="{% if channel.is_active == True %}Uptime: {{ channel.last_update|naturaltime|slice:":-4" }}{% else %}Downtime: {{ channel.last_update|naturaltime|slice:":-4" }}{% endif %}" {% if channel.is_active  == True %}style="background-color: rgba(46,160,67,0.15);">True{% else %}style="background-color: rgba(248,81,73,0.15)">False{% endif %}</td>
      </tr>
      {% endfor %}
    </table>
    <br/>
    <form id="rebal_form" action="/rebalancer/" method="post">
      {% csrf_token %}
      <label for="duration">Run Time (min): </label>
      <input id="duration" type="number" name="duration">
      <label for="value">Rebalance Amount (sats): </label>
      <input id="value" type="number" min="10" max="5000000" name="value">
      <label for="fee_limit">Fee Limit (ppm): </label>
      <input id="fee_limit" type="number" min="1" max="2500" name="fee_limit">
      <label for="last_hop_pubkey">Last Hop Pubkey: </label>
      <input id="last_hop_pubkey" type="text" name="last_hop_pubkey">
      <input type="submit" value="OK">
    </form>
  </div>
</div>
{% else %}
<div class="w3-container w3-padding-small">
  <center><h1>You dont have any channels to rebalance yet.</h1></center>
</div>
{% endif %}
{% include 'rebalances_table.html' with count=20 title='<a href="/rebalances" target="_blank">Rebalance Requests</a>' %}
{% include 'local_settings.html' with settings=local_settings title='Auto-Rebalancer' %}
{% endblock %}
