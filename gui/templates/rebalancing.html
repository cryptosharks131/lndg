{% extends "base.html" %}
{% block title %} {{ block.super }} - Rebalancing{% endblock %}
{% block content %}
{% load humanize %}
<div id="rebalances_container" class="w3-container w3-padding-small">
  <div class="w3-container w3-padding-small" style="overflow-x: scroll;overflow-y:scroll;max-height:500px">
    <table class="w3-table-all w3-centered w3-hoverable">
      <thead>
        <tr>
          <th onclick="sortTable(this, 0, 'String')">Channel ID</th>
          <th onclick="sortTable(this, 1, 'String', 0, 'a')">Peer Alias</th>
          <th onclick="sortTable(this, 2, ' (')">Outbound Liquidity</th>
          <th onclick="sortTable(this, 3, 'int', 0, 'label')">Capacity</th>
          <th onclick="sortTable(this, 4, ' (')">Inbound Liquidity</th>
          <th><a href="/rebalancing?is_open=true&private=false&is_active=true&auto_rebalance=false">Rebal Out?</a></th>
          <th onclick="sortTable(this, 6, '%')" title="This ratio must be below the channel's Max Cost %.">Fee Ratio</th>
          <th onclick="sortTable(this, 7, 'String')">Rebal In?</th>
          <th title="When AR is ENABLED for the channel, the size of the rebalance attempts that should be tried during attempts to refill the channel.">Target Amt</th>
          <th title="When AR is ENABLED, the maximum percentage amount of the local fee rate that can be used for the max rebalancing cost.">Max Cost %</th>
          <th title="When AR is NOT ENABLED for the channel, keep pushing OUT the channel until its outbound liquidity falls below the oTarget%.">oTarget%</th>
          <th title="When AR is ENABLED for the channel, keep pulling IN to the channel until its inbound liquidity falls below the iTarget%.">iTarget%</th>
          <th><a href="/rebalancing?is_open=true&private=false&is_active=true&auto_rebalance=true">AR</a></th>
          <th title="The rate of successful rebalances on this channel.">7-Day Rate</th>
          <th onclick="sortTable(this, 14, 'String')">Active</th>
        </tr>
      </thead>
      <tbody id="rebalancingTable">
      </tbody>
    </table>
  </div>
</div>
{% include 'rebalances_table.html' with count=20 title='<a href="/rebalances" target="_blank">Rebalance Requests</a>' %}
{% include 'local_settings.html' with settings=local_settings title='Auto-Rebalancer' %}
<div class="w3-container w3-padding-small">
  <h2>Manual Rebalancer Request</h2>
  <div class="w3-container w3-padding-32">
    <form action="/rebalancer/" method="post">
      {% csrf_token %}
      <label for="duration">Run Time (min): </label>
      <input id="duration" type="number" name="duration">
      <label for="value">Rebalance Amount (sats): </label>
      <input id="value" type="number" min="10" max="5000000" name="value">
      <label for="fee_limit">Fee Limit (ppm): </label>
      <input id="fee_limit" type="number" min="1" max="2500" name="fee_limit">
      <label for="last_hop_pubkey">Last Hop Pubkey: </label>
      <input id="last_hop_pubkey" type="text" name="last_hop_pubkey">
      <input type="submit" value="OK">
      <ul class="w3-ul w3-border" style="width:56.15%">
        <li><h3><label for="outgoing_chan_ids">Select Outgoing Channel IDs: </label></h3></li>
        {% for channel in rebalancer_form.outgoing_chan_ids %}
          <li>{{ channel }}</li>
        {% endfor %}
      </ul>
    </form>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const _7days_ago = new Date(new Date().setDate(new Date().getDate()-7)).toISOString().substring(0,19)
    const rebalancer_task = GET('rebalancer', {data: {stop__gt: _7days_ago, status__gt: 1, status__lt: 400 } })
    const resp = await GET('channels', {data: {is_open:true, private:false, auto_rebalance:'{{request.GET.auto_rebalance}}', is_active:'{{request.GET.is_active}}'} })
    const container = document.getElementById("rebalances_container")
    if (resp.results.length == 0){
      container.innerHTML = '<center><h1>You dont have any channels to rebalance yet.</h1></center>'
      return
    }

    const red = 'rgba(248,81,73,0.15)'
    const green = 'rgba(46,160,67,0.15)'
    const transformations = {
      "remote_pubkey": ch => ({innerHTML: `<a href="/channel?=${ch.chan_id}" target="_blank">${ch.short_chan_id}</a>`, title: `${ch.funding_txid}:${ch.output_index}`}),
      "chan_id": ch => ({innerHTML: `<a href="{{graph_links}}/{{network}}node/${ch.remote_pubkey}" target="_blank">${ch.alias == '' ? ch.remote_pubkey.slice(12) : ch.alias}</a>`, title: ch.remote_pubkey}),
      "local_balance": ch => ({innerHTML: `${ch.local_balance.toLocaleString()} (${ch.percent_outbound}%)`}),
      "capacity": ch => ({innerHTML: `<label>${ch.capacity.toLocaleString()}</label>
      <div class="progress w3-round w3-grey">
        <span class="value w3-round w3-blue" style="width:${ch.percent_outbound}%"></span>
      </div>`}),
      "remote_balance": ch => ({innerHTML: `${ch.remote_balance.toLocaleString()} (${ch.percent_inbound}%)`}),
      "rebal_out": ch => ({innerHTML: ch.percent_outbound >= ch.ar_out_target && !ch.auto_rebalance, style: {backgroundColor: ch.percent_outbound >= ch.ar_out_target && !ch.auto_rebalance ? green: red} }),
      "fee_ratio": ch => ({innerHTML: `${ch.fee_ratio}%`, style: {backgroundColor: ch.fee_check < 100 ? green : red} }),
      "rebalance_in": ch => ({innerHTML: ch.inbound_can >= 1 && ch.fee_check < 100 && ch.auto_rebalance ? `true (${ch.steps})` : 'false', title: ch.steps == 0 ? "" : `${ch.steps} rebalances to fulfill your in target %`, style: {backgroundColor: ch.inbound_can >= 1 && ch.fee_check < 100 && ch.auto_rebalance ? green : red} }),
      "ar_amt_target": ch => ({innerHTML: `<form action="/update_channel/" method="post">
        {% csrf_token %}
        <input style="text-align:center" id="target" type="number" min="0" max="100000000" name="target" value="${ch.ar_amt_target}">
        <input type="hidden" name="chan_id" value="${ch.chan_id}">
        <input type="hidden" name="update_target" value="2">
      </form>`}),
      "ar_max_cost": ch => ({innerHTML: `<form action="/update_channel/" method="post">
        {% csrf_token %}
        <input style="text-align:center" id="target" type="number" min="0" max="100" name="target" value="${ch.ar_max_cost}">
        <input type="hidden" name="chan_id" value="${ch.chan_id}">
        <input type="hidden" name="update_target" value="6">
      </form>`}),
      "ar_out_target": ch => ({innerHTML: `<form action="/update_channel/" method="post">
        {% csrf_token %}
        <input style="text-align:center" id="target" type="number" min="0" max="100" name="target" value="${ch.ar_out_target}">
        <input type="hidden" name="chan_id" value="${ch.chan_id}">
        <input type="hidden" name="update_target" value="4">
      </form>`, style: {backgroundColor: !ch.auto_rebalance ? green : red} }),
      "ar_in_target": ch => ({innerHTML: `<form action="/update_channel/" method="post">
        {% csrf_token %}
        <input style="text-align:center" id="target" type="number" min="0" max="100" name="target" value="${ch.ar_in_target}">
        <input type="hidden" name="chan_id" value="${ch.chan_id}">
        <input type="hidden" name="update_target" value="3">
      </form>`, style: {backgroundColor: ch.auto_rebalance ? green : red} }),
      "auto_rebalance": ch => ({innerHTML: `<form action="/update_channel/" method="post">
        {% csrf_token %}
        <input type="submit" value="${ch.auto_rebalance ? 'Dis' : 'En'}able">
        <input type="hidden" name="chan_id" value="${ch.chan_id}">
        <input type="hidden" name="update_target" value="5">
        <input type="hidden" name="target" value="0">
      </form>`, style: {backgroundColor: ch.auto_rebalance ? green : red} }),
      "rate_7day": ch => ({innerHTML: ch.attempts == 0 ? '---' : `${ch.success_rate}% (${ch.success}/${ch.attempts})`}),
      "is_active": ch => ({innerHTML: ch.is_active , title: (ch.is_active ? 'Uptime: ' : 'Downtime: ') + formatDate(ch.last_update).replace(" ago", ""), style: {backgroundColor: ch.is_active ? green : red} })
    }
    const rebalancer = await rebalancer_task
    let enabled = 0, elegible = 0, available = 0
    const rebal_table = document.getElementById("rebalancingTable")
    resp.results.forEach(ch => {
      //derived properties
      ch.local_balance += ch.pending_outbound
      ch.remote_balance += ch.pending_inbound
      ch.percent_inbound = parseInt(ch.remote_balance*100/ch.capacity)
      ch.percent_outbound = parseInt(ch.local_balance*100/ch.capacity)
      ch.inbound_can = ch.percent_inbound / ch.ar_in_target
      ch.fee_ratio = ch.local_fee_rate == 0 ? 100 : parseInt(ch.remote_fee_rate*100/ch.local_fee_rate)
      ch.fee_check = parseInt(ch.fee_ratio*100/ch.ar_max_cost)
      ch.steps = parseInt(ch.inbound_can < 1 ? 0 : ((ch.percent_inbound - ch.ar_in_target)/(ch.ar_amt_target*100/ch.capacity)+0.999))
      //global counters
      enabled += ch.auto_rebalance ? 1 : 0
      elegible += ch.is_active && ch.inbound_can > 1 && ch.fee_check < 100 ? 1 : 0
      available += ch.is_active && !ch.auto_rebalance && ch.percent_outbound / ch.ar_out_target >=1 ? 1: 0
      ch.attempts = 0, ch.success = 0, ch.success_rate = 0
      //rebalances status
      if(rebalancer.results.length == 0) return 
      for(r of rebalancer.results){
        if(r.last_hop_pubkey == ch.remote_pubkey){
          ch.attempts += 1
          if(r.status == 2) ch.success_rate = ch.success += 1
        }
      }
      ch.success_rate = parseInt(ch.success_rate/100)
    })
    container.insertAdjacentHTML('afterbegin', `<h2>Channel <a href="/rebalancing">Rebalancing</a> (currently scheduling ${elegible} of ${enabled} enabled channels for rebalancing via ${available} outbound channels)</h2>`)

    resp.results
      .sort((ch1, ch2) => { //sort by active, out%
        if(ch1.is_active == ch2.is_active) return ch1.percent_outbound - ch2.percent_outbound
        if(!ch2.is_active) return ch1
        if(!ch1.is_active) return ch2
      })
      .forEach(ch => rebal_table.append(use(transformations).fillWith(ch)))
  })
</script>
{% endblock %}
