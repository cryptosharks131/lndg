{% load humanize %}
<div id="rebalances_div_{{status}}" class="w3-container w3-padding-small">
  <h2>{% if status == 2 %}Successful{% elif status == 0 %}Pending{% elif status == 1 %}In-Flight{% else %}Last{% endif %} {{title}}</h2>
  <table id="rebalsTable_{{status}}" class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Requested</th>
      <th>Start</th>
      <th>Stop</th>
      <th>Scheduled for</th>
      <th>Elapsed</th>
      <th>Value</th>
      <th>Fee Limit</th>
      <th>Target PPM</th>
      <th>Fees Paid</th>
      <th>Last Hop</th>
      <th>Status</th>
      <th>Hash</th>
      <th>Action</th>
    </tr>
    <tbody id="rebalances_{{status}}">
    </tbody>
    <tfoot id="loadMoreRebals_{{status}}">
      <tr style="background-color:transparent;cursor:pointer;">
        <td colspan="13">
          <a onclick='loadRebals_{{status}}()'>Load More</a>
        </td>
      </tr>
    </tfoot>
  </table>
</div>
<script>
  var rapidFire = 'rapidFire', target_time = {{target_time}}
  function formatDuration(duration) {
    return `${duration} minute${duration === 1 ? 's':''}`
  }
  statuses = { 0: 'Pending â³', 1: 'In-Flight ðŸš€', 2: 'Successful âœ…', 3: 'Timeout â±ï¸', 4: 'No-Route â­•', 5: 'Error â›”', 6: 'Incorrect-Payment-Detailâ—', 7: 'Insufficient-BalanceðŸ’¸', 400: 'Rebalancer-Failed', 406: 'No-Sources â›½', 408: 'Rebalancer-Timeout â±ï¸', 499: 'Cancelled âœ–ï¸' }
  template = {
    'requested': rebalance => ({ innerHTML: formatDate(rebalance.requested), title: adjustTZ(rebalance.requested) }),
    'start': rebalance => ({ innerHTML: formatDate(rebalance.start), title: rebalance.start ? adjustTZ(rebalance.start) : '---' }),
    'stop': rebalance => ({ innerHTML: formatDate(rebalance.stop), title: rebalance.stop ? adjustTZ(rebalance.stop) : '---' }),
    'duration': rebalance => ({ innerHTML: formatDuration(rebalance.duration) }),
    'elapsed': rebalance => ({ innerHTML: formatDate(rebalance.start, rebalance.stop).replace(" ago", "") }),
    'value': rebalance => ({ innerHTML: Number(rebalance.value).toLocaleString() }),
    'fee_limit': rebalance => ({ innerHTML: Number(rebalance.fee_limit).toLocaleString() }),
    'ppm': rebalance => ({ innerHTML: Math.round(rebalance.fee_limit * 1000000 / rebalance.value).toLocaleString() }),
    'fees_paid': rebalance => ({ innerHTML: rebalance.status == 2 ? Number(rebalance.fees_paid).toLocaleString() : '---' }),
    'target_alias': rebalance => ({ innerHTML: rebalance.target_alias !== '' ? rebalance.target_alias : '---' }),
    'status': rebalance => ({ innerHTML: statuses[rebalance.status], title: rebalance.status }),
    'payment_hash': rebalance => ({ innerHTML: (rebalance.payment_hash || '').length == 0 ? '---' : 
      `<a href="/route?=${rebalance.payment_hash}" target="_blank">${rebalance.payment_hash.substring(0, 7)}</a>` }),
    'action': rebalance => {
      const input = document.createElement("button")
      if (rebalance.status != 0) {
        input.innerHTML = "ðŸ”‚"
        input.title = "Repeat this request"
        input.onclick = async function() {
          const { value, fee_limit, outgoing_chan_ids, last_hop_pubkey, duration, target_alias, manual } = rebalance
          const new_rebal = { value, fee_limit, outgoing_chan_ids, last_hop_pubkey, duration, target_alias, manual }
          const response = await POST('rebalancer', { body: new_rebal })
          const table = input.parentElement.parentElement.parentElement
          table.prepend(use(template).render(response))
        }
      }
      else {
        input.innerHTML = "ðŸ›‘"
        input.title = "Cancel this request"
        input.onclick = async function() {
          const response = await PUT(`rebalancer/${rebalance.id}`, { body: { status: 499 } })
          const table = input.parentElement.parentElement.parentElement
          const index = input.parentElement.parentElement.rowIndex - 1
          table.deleteRow(index)
          use(template).render(response, table.insertRow(index))
        }
      }
      return { innerHTML: input }
    }
  };
  function markRapidFire(tr, index) {
    const duration = tr.cells['duration']
    duration.innerHTML += ` ðŸ”¥`
    duration.title = `+${index} RapidFireðŸ”¥ rebalances:\nWhen the previous rebalance is successful, LNDg tries new 1min-long rebalances as a lift to quicker fulfill the AR target amount.`
  }
  async function buildTable(ev) {
    const res = await GET('rebalancer', { data: { limit: '{{count}}', status: '{{status}}', payment_hash: '{{payment_hash}}', last_hop_pubkey: '{{last_hop_pubkey}}' } })
    if (res.errors) return
    if (res.results.length == 0) {
      byId("rebalances_div_{{status}}").innerHTML = `<center><h1>You dont have any ${'{{status}}' == '' ? '' : statuses['{{status}}'].toLowerCase()} rebalance request</h1></center>`
      return
    }

    const table = byId("rebalances_{{status}}"), renderer = use(template)
    table.innerHTML = null
    for (const rebalance of res.results) {
      const tr = renderer.render(rebalance), isRapidFire = rebalance.duration === 1 && wait_period !== 1
      table.append(tr)
      tr.setAttribute(rapidFire, +isRapidFire)

      if(rebalance.status == 2) tr.style.backgroundColor = green
      if(isRapidFire) continue 
      var i = tr.rowIndex -2, prev = table.rows[i] 
      while(prev && parseInt(prev.getAttribute(rapidFire))){
        markRapidFire(prev, tr.rowIndex - prev.rowIndex)
        prev = table.rows[--i]
      } 
    }

    await auto_refresh(buildTable)
  }
  
  document.addEventListener('DOMContentLoaded', buildTable);

  async function loadRebals_{{status}}(){
    const status = "{{ status }}"
    const rebalsTable = byId('rebalsTable_' + status)
    const lastId = rebalsTable.tBodies[1].lastChild.objId
    const rebals_task = GET('rebalancer', { data: { last_hop_pubkey: "{{ last_hop_pubkey }}", id__lt: lastId, status: status, limit: "{{ load_count }}" } })
    build_rebals(rebals_task, rebalsTable, status)
  }
  async function build_rebals(rebals_task, rebalsTable, status) {
    let next_rebals = (await rebals_task).results
    if (next_rebals.length == 0) {
      byId("loadMoreRebals_" + status).style.display = "none"
      return
    }
    const tableBody = rebalsTable.tBodies[1], renderer = use(template)
    for (const rebalance of next_rebals) {
      const tr = renderer.render(rebalance), isRapidFire = rebalance.duration === 1 && wait_period !== 1
      tableBody.append(tr)
      tr.setAttribute(rapidFire, +isRapidFire)

      if(rebalance.status == 2) tr.style.backgroundColor = green
      if(isRapidFire) continue 
      var i = tr.rowIndex -2, prev = tableBody.rows[i] 
      while(prev && parseInt(prev.getAttribute(rapidFire))){
        markRapidFire(prev, tr.rowIndex - prev.rowIndex)
        prev = tableBody.rows[--i]
      } 
    }
  }
</script>