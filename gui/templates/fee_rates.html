{% extends "base.html" %}
{% block title %} {{ block.super }} - Fee Rates{% endblock %}
{% block content %}
{% load humanize %}
{% if local_settings %}
<div class="w3-container w3-padding-small">
  <h2>Auto-Fees Settings</h2>
  <table class="w3-table-all w3-centered w3-hoverable">
    <tr>
      <th>Key</th>
      <th>Value</th>
    </tr>
    {% for settings in local_settings %}
    <tr>
      <td>{{ settings.key }}</td>
      <td>
        <form action="/update_setting/" method="post">
          {% csrf_token %}
          {% if settings.key == 'AF-MaxRate' or settings.key == 'AF-MinRate' %}
            <input style="text-align:center" id="value" type="number" min="0" max="5000" name="value" value="{{ settings.value }}">
          {% elif settings.key == 'AF-Increment' or settings.key == 'AF-Multiplier' or settings.key == 'AF-FailedHTLCs' or settings.key == 'AF-UpdateHours' %}
            <input style="text-align:center" id="value" type="number" min="1" max="100" name="value" value="{{ settings.value }}">
          {% else %}
            <input style="text-align:center" id="value" type="number" min="0" max="1" name="value" value="{{ settings.value }}">
          {% endif %}
          <input type="hidden" name="key" value="{{ settings.key }}">
        </form>
      </td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}
{% if channels %}
<div class="w3-container w3-padding-small">
  <h2>Suggested Fee Rates</h2>
  <div class="w3-container w3-padding-small" style="overflow-x: scroll">
    <table id="feeTable" class="w3-table-all w3-centered w3-hoverable">
      <tr>
        <th onclick="sortTable(0, 'String', 'feeTable')">Channel ID</th>
        <th onclick="sortTable(1, 'String', 'feeTable', 0, true)">Peer Alias</th>
        <th onclick="sortTable(2, 'int', 'feeTable')">Capacity</th>
        <th onclick="sortTable(3, ' (', 'feeTable')">Outbound Liquidity</th>
        <th width=10%></th>
        <th onclick="sortTable(5, ' (', 'feeTable')">Inbound Liquidity</th>
        <th onclick="sortTable(6, ' | ', 'feeTable')" title="The value represents net flow --> (routed out - routed in) / capacity">7Day Flow</th>
        <th onclick="sortTable(7, 'int', 'feeTable')" title="The average rate earned outgoing on this channel">Out Rate</th>
        <th onclick="sortTable(8, 'int', 'feeTable')" title="The average rate paid for rebalances to refill this channel">Rebal Rate</th>
        <th onclick="sortTable(9, 'int', 'feeTable')" title="When revenue > 0 --> assisted revenue / revenue">Assisted Ratio</th>
        <th onclick="sortTable(10, 'int', 'feeTable')">Adjustment</th>
        <th onclick="sortTable(11, 'int', 'feeTable')" title="A suggested fee rate based on the flow pattern over the last 7 days">Suggested Rate</th>
        <th>oRate</th>
        <th onclick="sortTable(13, 'int', 'feeTable')">oBase</th>
        <th onclick="sortTable(14, '%', 'feeTable')">Max Cost</th>
        <th onclick="sortTable(15, 'int', 'feeTable')">iRate</th>
        <th onclick="sortTable(16, 'int', 'feeTable')">iBase</th>
        <th>Updated</th>
        <th>
          <form action="/update_setting/" method="post">
            {% csrf_token %}
            <input type="submit" value="Enable All">
            <input type="hidden" name="key" value="ALL-AF">
            <input type="hidden" name="value" value="1">
          </form>
        </th>
      </tr>
      {% for channel in channels %}
      <tr>
        <td title="{{ channel.funding_txid }}:{{ channel.output_index }}"><a href="/channel?={{ channel.chan_id }}" target="_blank">{{ channel.short_chan_id }}</a></td>
        <td title="{{ channel.remote_pubkey }}">{% if channel.private == False %}<a href="{{ graph_links }}/{{ network }}node/{{ channel.remote_pubkey }}" target="_blank">{% endif %}{% if channel.alias == '' %}{{ channel.remote_pubkey|slice:":12" }}{% else %}{{ channel.alias }}{% endif %}{% if channel.private == False %}</a>{% endif %}</td>
        <td>{{ channel.capacity|intcomma }}</td>
        <td>{{ channel.local_balance|intcomma }} ({{ channel.out_percent }}%)</td>
        <td><div class="w3-orange w3-round">{% if channel.in_percent == 0 %}<div class="w3-container w3-round w3-blue" style="height:16px;width:100%"></div>{% elif channel.out_percent == 0 %}<div class="w3-container w3-round w3-orange" style="height:16px;width:100%"></div>{% else %}<div class="w3-container w3-round w3-blue" style="height:16px;width:{{ channel.out_percent }}%"></div>{% endif %}</div></td>
        <td>{{ channel.remote_balance|intcomma }} ({{ channel.in_percent }}%)</td>
        <td>{% if channel.net_routed_7day != 0 %}{{ channel.net_routed_7day }} | {% endif %}{% if channel.net_routed_7day > 0 %}OUT{% elif channel.net_routed_7day < 0 %}IN{% else %}---{% endif %}</td>
        <td>{{ channel.out_rate }}</td>
        <td>{{ channel.rebal_ppm }}</td>
        <td>{{ channel.assisted_ratio }}</td>
        <td>{{ channel.adjustment }}</td>
        <td>{{ channel.new_rate|intcomma }}</td>
        <td>
          <form action="/update_channel/" method="post">
            {% csrf_token %}
            <input style="text-align:center" id="target" type="number" min="0" max="100000" name="target" value="{{ channel.local_fee_rate }}">
            <input type="hidden" name="chan_id" value="{{ channel.chan_id }}">
            <input type="hidden" name="update_target" value="1">
          </form>
        </td>
        <td>{{ channel.local_base_fee|intcomma }}</td>
        <td {% if channel.auto_rebalance == True %}style="background-color: rgba(56,139,253,0.15)"{% endif %}>{{ channel.ar_max_cost }}%</td>
        <td>{{ channel.remote_fee_rate|intcomma }}</td>
        <td>{{ channel.remote_base_fee|intcomma }}</td>
        <td {% if channel.eligible == True %}style="background-color: rgba(248,81,73,0.15);"{% else %}style="background-color: rgba(56,139,253,0.15)"{% endif %}>{{ channel.fees_updated|naturaltime }}</td>
        <td {% if channel.auto_fees == False %}style="background-color: rgba(248,81,73,0.15);"{% else %}style="background-color: rgba(56,139,253,0.15)"{% endif %}>
          <form action="/update_channel/" method="post">
            {% csrf_token %}
            <input type="submit" value="{% if channel.auto_fees == True %}Disable{% else %}Enable{% endif %}">
            <input type="hidden" name="chan_id" value="{{ channel.chan_id }}">
            <input type="hidden" name="update_target" value="8">
            <input type="hidden" name="target" value="0">
          </form>
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
</div>
{% endif %}
{% if not channels %}
<div class="w3-container w3-padding-small">
  <center><h1>You dont have any channels to analyze yet!</h1></center>
</div>
{% endif %}
{% endblock %}